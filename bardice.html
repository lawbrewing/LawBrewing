<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Law Brewing Bar Dice</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rye&family=Roboto:wght@400;700&display=swap');

        body { 
            font-family: 'Roboto', sans-serif;
            background-color: #1a1a1a; 
            color: white; 
            overflow-x: hidden; 
        }
        #root { width: 100%; min-height: 100vh; display: flex; justify-content: center; }
        .loading-text { margin-top: 20px; color: #888; text-align: center; }
        
        .font-western { font-family: 'Rye', serif; }
        .dice-face { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); user-select: none; }
        .dice-face:active { transform: scale(0.95); }
        .glass-panel { background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .wood-texture {
            background-color: #3e2723;
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 2px, transparent 2px, transparent 10px);
            width: 100%;
            min-height: 100vh;
        }
        @keyframes pulse-yellow {
            0%, 100% { box-shadow: 0 0 0 0px rgba(234, 179, 8, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); }
        }
        .btn-pulse { animation: pulse-yellow 2s infinite; }
        .active-turn { border-color: #eab308; box-shadow: 0 0 15px rgba(234, 179, 8, 0.3); transform: scale(1.02); }
        .inactive-turn { opacity: 0.6; }
        
        /* Cheat Sheet Tooltip */
        .cheat-sheet-container:hover .cheat-sheet { display: block; }
        /* High Z-index to ensure it shows over game board */
        .cheat-sheet { z-index: 9999; }
    </style>

    <!-- Error Handler -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Critical Runtime Error:", message, "Line:", lineno);
            if (message.includes("React") || message.includes("Minified") || message.includes("define")) {
                 document.body.innerHTML = "<div style='color:white;padding:20px;text-align:center'><h2>Game Error Detected</h2><p>A critical rendering error occurred. Please check the browser console for specific details (F12).</p><small>"+message+"</small></div>";
            }
        };
    </script>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
</head>
<body>
    
    <div id="root"><div class="loading-text">Loading Law Brewing Bar Dice...</div></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS (SVG DEFINITIONS) ---
        const Icons = {
            Star: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 0L14.59 8.06L22.5 5.5L17.3 12L22.5 18.5L14.59 15.94L12 24L9.41 15.94L1.5 18.5L6.7 12L1.5 5.5L9.41 8.06L12 0Z"/></svg>,
            Beer: () => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M7 7h10v11a3 3 0 0 1-3 3H9a3 3 0 0 1-3-3V7Z" fill="#eab308" stroke="#eab308" fillOpacity="0.5"/>
                    <path d="M6 7a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v0H6v0Z" fill="white" stroke="white"/>
                    <path d="M17 8h1a4 4 0 0 1 0 8h-1" stroke="currentColor"/>
                    <line x1="7" y1="7" x2="17" y2="7" stroke="currentColor"/>
                    <line x1="7" y1="21" x2="17" y2="21" stroke="currentColor"/>
                    <line x1="7" y1="7" x2="7" y2="21" stroke="currentColor"/>
                    <line x1="17" y1="7" x2="17" y2="21" stroke="currentColor"/>
                </svg>
            ),
            DollarSign: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            Trophy: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            Skull: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="M12.5 17l.5-2 .5 2h2l.5-2 .5 2"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></svg>,
            RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>,
            Zap: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            TrendingUp: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Help: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            Mug: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 6h2a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M4 6h13v14H4V6Z"/><path d="M8 6v14"/><path d="M12 6v14"/><path d="M4 10h13"/></svg>,
            Party: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M15 11a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path d="M19 12c0 2.2-1.5 4.3-4.5 4.3S10 14.2 10 12c0-2.3 1.5-4.3 4.5-4.3S19 9.8 19 12z"/><path d="M21 12c0 3.3-2.5 6-7 6s-7-2.7-7-6c0-3.3 2.5-6 7-6s7 2.7 7 6z"/><path d="M22 12c0 4.4-3.4 8-10 8S2 16.4 2 12 5.4 4 12 4s10 3.6 10 8z"/></svg>,
        };

        const Icon = ({ name, size = 16, className = "" }) => {
            const Component = Icons[name];
            if (!Component) return null;
            return <div className={className} style={{ width: size, height: size, display: 'inline-block' }}><Component /></div>;
        };

        // --- CUSTOM AVATARS ---
        const Avatars = {
            Pete: () => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" className="w-full h-full">
                    <rect width="100" height="100" fill="#4a5568"/>
                    <path d="M20 60 Q50 90 80 60 L80 40 L20 40 Z" fill="#cbd5e0"/>
                    <circle cx="50" cy="45" r="25" fill="#f6ad55"/>
                    <path d="M10 40 L90 40 L80 15 L20 15 Z" fill="#2d3748"/>
                    <circle cx="40" cy="45" r="3" fill="#1a202c"/>
                    <circle cx="60" cy="45" r="3" fill="#1a202c"/>
                </svg>
            ),
            Rick: () => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" className="w-full h-full">
                    <rect width="100" height="100" fill="#2b6cb0"/>
                    <rect x="25" y="25" width="50" height="60" rx="10" fill="#f6ad55"/>
                    <path d="M25 25 L35 10 L65 10 L75 25 Z" fill="#1a202c"/>
                    <rect x="30" y="40" width="15" height="10" fill="black"/>
                    <rect x="55" y="40" width="15" height="10" fill="black"/>
                    <line x1="45" y1="45" x2="55" y2="45" stroke="black" strokeWidth="2"/>
                    <path d="M40 70 Q50 75 60 68" stroke="black" strokeWidth="3" fill="none"/>
                </svg>
            ),
            Mara: () => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" className="w-full h-full">
                    <rect width="100" height="100" fill="#d53f8c"/>
                    <path d="M20 20 Q50 0 80 20 L90 90 L10 90 Z" fill="#5D4037"/>
                    <circle cx="50" cy="50" r="25" fill="#f6e05e"/>
                    <circle cx="40" cy="48" r="3" fill="#1a202c"/>
                    <circle cx="60" cy="48" r="3" fill="#1a202c"/>
                    <path d="M40 60 Q50 70 60 60" stroke="#c53030" strokeWidth="2" fill="none"/>
                </svg>
            ),
            James: () => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" className="w-full h-full">
                    <rect width="100" height="100" fill="#1a202c"/>
                    <ellipse cx="50" cy="55" rx="35" ry="30" fill="#c0b2a4"/>
                    <circle cx="35" cy="50" r="5" fill="#3182ce"/>
                    <circle cx="65" cy="50" r="5" fill="#3182ce"/>
                    <circle cx="35" cy="50" r="2" fill="black"/>
                    <circle cx="65" cy="50" r="2" fill="black"/>
                    <path d="M45 60 L50 70 L55 60 Z" fill="#a09284"/>
                    <line x1="40" y1="80" x2="60" y2="80" stroke="#718096" strokeWidth="3"/>
                </svg>
            )
        };

        // --- CONSTANTS & LOGIC ---
        const HOUSE_START_MONEY = 50;
        const PATRON_START_MONEY = 50;
        const CONTRIBUTION = 10;
        const BUY_A_ROUND_COST = 20;
        const ROUND_DRINKS = ["nIPLy", "Raspberry Cabana", "NOT Burnt Marshmallow Pastry Stout", "LFO", "subLime", "Hopped Up on Enemy's Blood"];
        const GAME_STATE_BAR_VICTORY = 'BAR_VICTORY'; 

        const HAND_RANKS = {
            FIVE_OF_A_KIND: 8, FOUR_OF_A_KIND: 7, FULL_HOUSE: 6, STRAIGHT: 5,
            THREE_OF_A_KIND: 4, TWO_PAIR: 3, ONE_PAIR: 2, HIGH_CARD: 1
        };

        const HAND_NAMES = {
            8: "Keg Stand (5 of a Kind)", 7: "Case of Beer (4 of a Kind)", 6: "Full Tab (Full House)",
            5: "Flight (Straight)", 4: "Six Pack (3 of a Kind)", 3: "Double Fisted (Two Pair)", 2: "Solo Cup (Pair)", 1: "Spilled Drink (High Card)"
        };

        const BASE_PATRON_TYPES = [
            { name: "Pinecone Pete", type: "Conservative", Avatar: Avatars.Pete },
            { name: "Rick the Prick", type: "Aggressive", Avatar: Avatars.Rick },
            { name: "Mara Lawson", type: "Random", Avatar: Avatars.Mara },
            { name: "James Roberts", type: "Calculator", Avatar: Avatars.James }
        ];

        // Utility to find the correct Avatar function by name
        const getAvatarComponent = (name) => {
            const patronType = BASE_PATRON_TYPES.find(p => p.name === name);
            return patronType ? patronType.Avatar : Avatars.Pete; 
        };

        const evaluateHand = (dice) => {
            if (!dice || dice[0] === 0) return null; 

            try {
                const counts = {};
                let wilds = 0;
                dice.forEach(d => {
                    if (d === 1) wilds++;
                    else counts[d] = (counts[d] || 0) + 1;
                });

                const uniqueValues = Object.keys(counts).map(Number).sort((a,b) => b-a);
                const maxCount = uniqueValues.length > 0 ? Math.max(...Object.values(counts)) : 0;
                
                if (maxCount + wilds >= 5) return { rank: HAND_RANKS.FIVE_OF_A_KIND, value: uniqueValues[0] || 6 };
                if (maxCount + wilds >= 4) return { rank: HAND_RANKS.FOUR_OF_A_KIND, value: uniqueValues[0] };

                // Full House
                for (let val of uniqueValues) {
                    let w = wilds;
                    let c = counts[val];
                    if (c + w >= 3) {
                        let w_remain = w - (3 - c);
                        if (w_remain < 0) w_remain = 0;
                        for (let val2 of uniqueValues) {
                            if (val2 === val) continue;
                            if (counts[val2] + w_remain >= 2) return { rank: HAND_RANKS.FULL_HOUSE, value: val * 10 + val2 };
                        }
                    }
                }

                // Straight Logic (2-3-4-5-6)
                const needed = [2, 3, 4, 5, 6];
                let missingCount = 0;
                needed.forEach(n => {
                    if (!dice.includes(n)) missingCount++;
                });
                
                if (missingCount <= wilds) {
                    return { rank: HAND_RANKS.STRAIGHT, value: 6 };
                }

                if (maxCount + wilds >= 3) return { rank: HAND_RANKS.THREE_OF_A_KIND, value: uniqueValues[0] };

                let pairs = 0;
                let w_temp = wilds;
                for (let val of uniqueValues) {
                    if (counts[val] >= 2) { pairs++; }
                    else if (counts[val] === 1 && w_temp > 0) { pairs++; w_temp--; }
                }
                if (pairs >= 2) return { rank: HAND_RANKS.TWO_PAIR, value: uniqueValues[0] };
                if (maxCount + wilds >= 2) return { rank: HAND_RANKS.ONE_PAIR, value: uniqueValues[0] };

                return { rank: HAND_RANKS.HIGH_CARD, value: Math.max(...dice) };
            } catch (e) {
                console.error("Eval Error", e);
                return { rank: 1, value: 1 };
            }
        };

        const Die = ({ value, held, onClick, size = "large" }) => {
            const isOne = value === 1;
            const isZero = value === 0;
            const sizeClass = size === "large" ? "w-16 h-16 text-3xl" : "w-8 h-8 text-sm";
            
            if (isZero) {
                 return (
                    <div className={`${sizeClass} flex items-center justify-center rounded-xl border-2 border-slate-700 bg-slate-900 text-slate-700 shadow-inner`}>
                        <Icon name="Mug" size={size === "large" ? 24 : 12} />
                    </div>
                 );
            }

            return (
                <div onClick={onClick} className={`${sizeClass} flex items-center justify-center rounded-xl border-2 font-bold cursor-pointer shadow-lg dice-face ${held ? 'border-yellow-500 bg-yellow-900/50 -translate-y-2' : 'border-slate-600 bg-slate-800'} ${isOne ? 'text-yellow-400' : 'text-white'} hover:bg-slate-700`}>
                    {isOne ? <Icon name="Star" size={size === "large" ? 36 : 18} /> : value}
                </div>
            );
        };

        const App = () => {
            const [gameState, setGameState] = useState('START');
            const [funds, setFunds] = useState(HOUSE_START_MONEY);
            const [pot, setPot] = useState(0); 
            const [round, setRound] = useState(1);
            const [message, setMessage] = useState("Welcome to Law Brewing!");
            
            const [playerDice, setPlayerDice] = useState([0, 0, 0, 0, 0]);
            const [heldDice, setHeldDice] = useState([false, false, false, false, false]);
            const [rollsLeft, setRollsLeft] = useState(3);
            const [playerHand, setPlayerHand] = useState(null);
            
            const [opponents, setOpponents] = useState([]);
            const [retiredPatronTypes, setRetiredPatronTypes] = useState([]);
            
            const [turnOrder, setTurnOrder] = useState([]); 
            const [currentTurnIndex, setCurrentTurnIndex] = useState(0);
            const [lastRoundRankings, setLastRoundRankings] = useState([]);

            const [imgError, setImgError] = useState(false);

            // --- AI & TURN MANAGEMENT ---

            // Auto-play AI turns
            useEffect(() => {
                if (gameState === 'ROLLING') {
                    const activeId = turnOrder[currentTurnIndex];
                    if (activeId !== undefined && activeId !== 'player') {
                        const aiDelay = setTimeout(() => {
                            playAITurn(activeId);
                        }, 1200);
                        return () => clearTimeout(aiDelay);
                    }
                }
            }, [currentTurnIndex, gameState, turnOrder]);

            // Auto-end Player Turn ONLY when rolls run out
            useEffect(() => {
                 if (gameState === 'ROLLING' && turnOrder[currentTurnIndex] === 'player' && rollsLeft === 0) {
                      const timer = setTimeout(() => advanceTurn(), 1000);
                      return () => clearTimeout(timer);
                 }
            }, [rollsLeft, currentTurnIndex, gameState, turnOrder]);

            const findReplacementPatron = (ignoreList = []) => {
                const currentPatronNames = opponents.map(o => o.typeId).filter(Boolean);
                const usedPatronNames = [...retiredPatronTypes, ...currentPatronNames, ...ignoreList];
                
                const replacementType = BASE_PATRON_TYPES.find(p => !usedPatronNames.includes(p.name));
                
                if (!replacementType) return null; 

                return {
                    ...replacementType,
                    id: Math.max(...opponents.map(o => o.id), 0) + 1, 
                    dice: [0,0,0,0,0],
                    hand: null,
                    money: PATRON_START_MONEY,
                    status: 'Waiting',
                    typeId: replacementType.name,
                    Avatar: getAvatarComponent(replacementType.name)
                };
            };

            const playAITurn = (aiId) => {
                setOpponents(prev => {
                    return prev.map(opp => {
                        if (opp.id === aiId) {
                            let currentDice = [1,1,1,1,1].map(()=>Math.ceil(Math.random()*6));
                            for(let r=0; r<2; r++) { 
                                const keeps = getAIKeeps(currentDice, opp.type);
                                currentDice = currentDice.map((d, i) => keeps.includes(i) ? d : Math.ceil(Math.random() * 6));
                            }
                            return { 
                                ...opp, 
                                dice: currentDice, 
                                hand: evaluateHand(currentDice),
                                status: 'Done' 
                            };
                        }
                        return opp;
                    });
                });
                advanceTurn();
            };

            const advanceTurn = () => {
                const nextIndex = currentTurnIndex + 1;
                if (nextIndex >= turnOrder.length) {
                    finishRound();
                } else {
                    setCurrentTurnIndex(nextIndex);
                    const nextId = turnOrder[nextIndex];
                    if (nextId === 'player') {
                        setPlayerDice([0,0,0,0,0]); 
                        setHeldDice([false,false,false,false,false]);
                        setRollsLeft(3);
                        setMessage("It's your turn! Roll for the pot.");
                    } else {
                        const oppName = opponents.find(o => o.id === nextId)?.name || "Opponent";
                        setMessage(`Waiting for ${oppName}...`);
                    }
                }
            };

            const initializeGame = () => {
                setFunds(HOUSE_START_MONEY);
                setRound(1);
                setLastRoundRankings([]);
                setRetiredPatronTypes([]); 
                
                const allPatronTypes = [...BASE_PATRON_TYPES];
                const shuffled = allPatronTypes.sort(() => 0.5 - Math.random());
                const initialTypes = shuffled.slice(0, 3);

                const newOpponents = initialTypes.map((pType, i) => ({
                    ...pType,
                    id: i,
                    dice: [0,0,0,0,0],
                    hand: null,
                    money: PATRON_START_MONEY,
                    status: 'Waiting',
                    typeId: pType.name,
                    Avatar: getAvatarComponent(pType.name)
                }));
                
                setOpponents(newOpponents);

                const order = [...newOpponents.map(o => o.id), 'player'];
                setupRound(order, newOpponents);
            };

            const startRound = () => {
                setRound(r => r + 1);

                let order = [];
                if (lastRoundRankings.length > 0) {
                    const worstToBest = [...lastRoundRankings].reverse();
                    order = worstToBest.map(p => p.id);
                } else {
                    order = [...opponents.map(o => o.id), 'player'];
                }
                setupRound(order, opponents);
            };

            const setupRound = (order, currentOpponents) => {
                let currentFunds = funds;
                let newOpponents = [...currentOpponents];
                
                // Contributions
                currentFunds -= CONTRIBUTION;
                newOpponents = newOpponents.map(opp => ({ ...opp, money: opp.money - CONTRIBUTION }));

                const totalPot = (currentOpponents.length + 1) * CONTRIBUTION;
                
                setFunds(currentFunds);
                setPot(totalPot);
                setPlayerDice([0,0,0,0,0]);
                setPlayerHand(null);
                setHeldDice([false, false, false, false, false]);
                setRollsLeft(3);

                const resetOpponents = newOpponents.map(opp => ({
                    ...opp,
                    dice: [0,0,0,0,0], 
                    hand: null, 
                    status: 'Waiting'
                }));
                setOpponents(resetOpponents);

                setTurnOrder(order);
                setCurrentTurnIndex(0);
                setGameState('ROLLING');
                
                const firstId = order[0];
                if (firstId === 'player') setMessage(`Your $${CONTRIBUTION} is in. Pot is $${totalPot}. You go first!`);
                else {
                    const name = resetOpponents.find(o => o.id === firstId)?.name;
                    setMessage(`${name} starts. Pot: $${totalPot}.`);
                }

                 if (currentFunds <= 0) {
                     setMessage("Womp. Womp. The House is immediately out of funds after contributing to the pot.");
                     setTimeout(() => setGameState('GAME_OVER'), 500);
                 }
            };

            const rollDice = () => {
                if (rollsLeft <= 0 || turnOrder[currentTurnIndex] !== 'player') return;
                
                const newDice = playerDice.map((val, idx) => {
                    if (heldDice[idx] && val !== 0) { 
                        return val;
                    }
                    return Math.ceil(Math.random() * 6);
                });
                setPlayerDice(newDice);
                
                const newRolls = rollsLeft - 1;
                setRollsLeft(newRolls);
                // NOTE: Advance turn logic is handled by useEffect watching rollsLeft
            };

            const forceFinish = () => {
                if (turnOrder[currentTurnIndex] !== 'player') return;
                setRollsLeft(0); // This triggers the useEffect to advance turn
            };

            const getAIKeeps = (dice, type) => {
                let keeps = [];
                dice.forEach((d, i) => { if(d === 1) keeps.push(i); });
                const counts = {};
                dice.forEach(d => counts[d] = (counts[d] || 0) + 1);
                for (let i=0; i<5; i++) {
                    if (keeps.includes(i)) continue;
                    const val = dice[i];
                    if (counts[val] >= 2) keeps.push(i);
                    if (type === 'Aggressive' && val >= 5) keeps.push(i);
                }
                return keeps;
            };

            const finishRound = () => {
                setGameState('EVALUATION');
                const finalPHand = evaluateHand(playerDice);
                setPlayerHand(finalPHand);
                const finalOpponents = opponents.map(opp => ({ ...opp, hand: evaluateHand(opp.dice) }));
                setOpponents(finalOpponents);
                setTimeout(() => determineWinner(finalPHand, finalOpponents), 1000);
            };

            const determineWinner = (pHand, opps) => {
                const safePHand = pHand || { rank: 1, value: 0 };
                const safeOpps = opps.map(o => ({...o, hand: o.hand || {rank:1, value:0}}));

                const allPlayers = [
                    { id: 'player', name: 'You', hand: safePHand },
                    ...safeOpps.map(o => ({ id: o.id, name: o.name, hand: o.hand, money: o.money, typeId: o.typeId }))
                ];

                allPlayers.sort((a, b) => {
                    if (b.hand.rank !== a.hand.rank) return b.hand.rank - a.hand.rank;
                    return b.hand.value - a.hand.value;
                });
                
                setLastRoundRankings(allPlayers);

                const loser = allPlayers[allPlayers.length - 1];
                const winner = allPlayers[0];
                const losingDrink = ROUND_DRINKS[Math.floor(Math.random() * ROUND_DRINKS.length)];
                
                let msg = "";
                let newFunds = funds; 
                let loserPatron = null; 

                // --- 1. Pot Distribution ---
                if (winner.id === 'player') {
                    newFunds += pot; 
                    msg += `WINNER: You won the $${pot} Pot!`;
                } else {
                    const winnerPatron = opps.find(o => o.id === winner.id);
                    setOpponents(prev => prev.map(o => o.id === winner.id ? { ...o, money: o.money + pot } : o));
                    msg += `WINNER: ${winnerPatron.name} won the $${pot} Pot.`;
                }
                
                msg += `\n`;

                // --- 2. Loser Pays $20 Penalty ---
                if (loser.id === 'player') {
                    newFunds -= BUY_A_ROUND_COST;
                    msg += `LOSER: You had the lowest hand (${HAND_NAMES[loser.hand.rank].split('(')[0]}) and bought a round of ${losingDrink} (-$${BUY_A_ROUND_COST}).`;
                } else {
                    loserPatron = opps.find(o => o.id === loser.id);
                    const newPatronMoney = loserPatron.money - BUY_A_ROUND_COST;
                    
                    if (newPatronMoney <= 0) {
                        // BANKRUPTCY & REPLACEMENT
                        setRetiredPatronTypes(prev => [...prev, loserPatron.typeId]);
                        const replacement = findReplacementPatron([loserPatron.typeId]);
                        
                        if (replacement) {
                            setOpponents(prev => prev.map(opp => opp.id === loser.id ? replacement : opp));
                            newFunds += loserPatron.money; 
                            msg += `LOSER: ${loserPatron.name} went BUST buying a round of ${losingDrink}! Replaced by ${replacement.name}.`;
                        } else {
                            newFunds += loserPatron.money;
                            msg += `LOSER: ${loserPatron.name} bought a round of ${losingDrink}! \n\n ALL PATRONS HAVE BEEN BANKRUPTED!`;
                            setFunds(newFunds);
                            setPot(0);
                            setGameState(GAME_STATE_BAR_VICTORY);
                            setMessage(msg); 
                            return; 
                        }
                    } else {
                        setOpponents(prev => prev.map(o => o.id === loser.id ? { ...o, money: newPatronMoney } : o));
                        newFunds += BUY_A_ROUND_COST;
                        msg += `LOSER: ${loserPatron.name} lost and bought a round of ${losingDrink} ($${BUY_A_ROUND_COST}).`;
                    }
                }
                
                setPot(0);
                
                if (newFunds <= 0) {
                    setMessage(`FINAL: ${msg} \n\n Womp. Womp. The House is out of money.`);
                    setFunds(0); 
                    setTimeout(() => setGameState('GAME_OVER'), 3000);
                } else {
                    setFunds(newFunds);
                    setMessage(msg); 
                    setGameState('ROUND_END');
                }
            };

            const toggleDie = (idx) => {
                if (gameState !== 'ROLLING' || rollsLeft === 3 || turnOrder[currentTurnIndex] !== 'player') return;
                if (playerDice[idx] === 0) return;
                
                const newHeld = [...heldDice];
                newHeld[idx] = !newHeld[idx];
                setHeldDice(newHeld);
            };

            const currentHandDisplay = useMemo(() => evaluateHand(playerDice), [playerDice]);
            const isPlayerTurn = gameState === 'ROLLING' && turnOrder[currentTurnIndex] === 'player';

            return (
                <div className="wood-texture flex flex-col items-center">
                    <div className="absolute inset-0 bg-black/40 pointer-events-none"></div>
                    
                    {/* Header */}
                    <div className="w-full max-w-4xl p-3 z-10 flex justify-between items-center glass-panel mt-4 rounded-lg shadow-2xl mx-2 relative z-[50]">
                        <div className="flex items-center gap-3">
                            <div className="w-16 h-16 bg-black rounded-full border-2 border-yellow-600 flex items-center justify-center overflow-hidden shrink-0 relative">
                                {!imgError ? (
                                    <img src="1000001562.png" onError={() => setImgError(true)} className="w-full h-full object-cover" alt="Logo" />
                                ) : (
                                    <div className="flex flex-col items-center justify-center text-yellow-600"><span className="text-sm font-western mt-1">LAW</span></div>
                                )}
                            </div>
                            <div>
                                <h1 className="text-xl font-western text-yellow-500 tracking-wider">LAW BREWING BAR DICE</h1>
                                <div className="flex gap-3 text-xs text-slate-300 font-mono">
                                    <span title="House Funds: Start at $50. Game over if $0 is reached." className="flex items-center gap-1 cursor-help"><Icon name="DollarSign" size={12} className="text-green-400"/> {funds}</span>
                                    <span title="Current Pot: All players contribute $10. The winner takes this pot." className="flex items-center gap-1 cursor-help"><Icon name="Beer" size={12} className="text-amber-500"/> ${pot}</span>
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 shrink-0">
                            <div className="relative cheat-sheet-container">
                                <button className="flex items-center gap-1 text-xs text-slate-300 hover:text-white border border-slate-600 px-2 py-1 rounded bg-slate-800">
                                    <Icon name="Help" size={12} /> Hand Ranks
                                </button>
                                <div className="cheat-sheet hidden absolute right-0 top-8 w-64 bg-slate-900 border border-yellow-600 rounded p-3 shadow-xl text-xs">
                                    <h3 className="font-bold text-yellow-500 mb-2 border-b border-slate-700 pb-1">Hand Rankings</h3>
                                    <ul className="space-y-1 text-slate-300">
                                        <li><span className="text-yellow-500">8.</span> Keg Stand (5-Kind)</li>
                                        <li><span className="text-yellow-500">7.</span> Case (4-Kind)</li>
                                        <li><span className="text-yellow-500">6.</span> Full Tab (Full House)</li>
                                        <li><span className="text-yellow-500">5.</span> Flight (Straight)</li>
                                        <li><span className="text-yellow-500">4.</span> Six Pack (3-Kind)</li>
                                        <li><span className="text-yellow-500">3.</span> Double Fisted (2 Pair)</li>
                                        <li><span className="text-yellow-500">2.</span> Solo Cup (Pair)</li>
                                        <li><span className="text-yellow-500">1.</span> Spilled Drink (High)</li>
                                    </ul>
                                </div>
                            </div>
                            <div className="text-right">
                                <div className="text-[10px] text-slate-400 uppercase tracking-widest">Round</div>
                                <div className="text-2xl font-western text-white">{round}</div>
                            </div>
                        </div>
                    </div>

                    {/* Game Board */}
                    <div className="w-full max-w-4xl mt-4 z-10 flex flex-col gap-4 px-3 pb-8">
                        {/* Message Bar */}
                        <div className="bg-slate-900/90 border-l-4 border-yellow-500 p-3 rounded text-center shadow-lg min-h-[3.5rem] flex items-center justify-center transition-all z-[10]">
                            <span className="text-sm md:text-base font-medium animate-pulse message-box">{message}</span>
                        </div>

                        {/* Opponents Grid */}
                        <div className="grid grid-cols-3 gap-2">
                            {opponents.map((opp) => {
                                const isMyTurn = gameState === 'ROLLING' && turnOrder[currentTurnIndex] === opp.id;
                                const AvatarComp = opp.Avatar;
                                return (
                                    <div key={opp.id} className={`glass-panel p-2 rounded-lg flex flex-col items-center gap-1 transition-all duration-500 ${isMyTurn ? 'active-turn' : 'inactive-turn'} ${gameState === 'ROUND_END' && opp.hand && opp.hand.rank < 3 ? 'border-red-500 bg-red-900/20' : ''}`}>
                                        <div className="flex flex-col md:flex-row items-center gap-1 mb-1">
                                            <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center shrink-0 overflow-hidden border border-slate-500">
                                                <AvatarComp />
                                            </div>
                                            <div className="text-center md:text-left overflow-hidden">
                                                <div className="text-[10px] md:text-xs font-bold text-slate-200 truncate w-full">{opp.name}</div>
                                                <div className="flex items-center justify-center text-[10px] text-green-400 font-mono">
                                                    <Icon name="DollarSign" size={10} className="text-green-400"/> {opp.money}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex gap-1 justify-center flex-wrap scale-90 origin-top">
                                            {opp.dice.map((d, i) => <Die key={i} value={d} size="small" />)}
                                        </div>
                                        <div className="text-[10px] font-bold text-yellow-500 mt-1 uppercase text-center h-4 leading-none">
                                            {opp.hand ? HAND_NAMES[opp.hand.rank].split('(')[0] : (d => {
                                                if (opp.dice[0] === 0) return 'Waiting...';
                                                return '...';
                                            })()}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {/* Player Area */}
                        {gameState === 'START' || gameState === 'GAME_OVER' || gameState === GAME_STATE_BAR_VICTORY ? (
                            <div className="glass-panel p-6 rounded-xl flex flex-col items-center justify-center text-center gap-4 mt-2">
                                {gameState === GAME_STATE_BAR_VICTORY ? (
                                    <>
                                        <div className="text-yellow-500"><Icon name="Party" size={48} /></div>
                                        <h2 className="text-2xl font-western text-yellow-500">BAR CONQUERS ALL!</h2>
                                        <p className="text-slate-300 text-sm">
                                            You successfully bankrupted every patron and secured the House's future!
                                        </p>
                                        <div className="text-lg font-bold text-green-400 flex items-center gap-2 mt-4">
                                            Final Funds: <Icon name="DollarSign" size={20} />${funds}
                                        </div>
                                    </>
                                ) : gameState === 'GAME_OVER' ? (
                                    <>
                                        <div className="text-red-500"><Icon name="Skull" size={48} /></div>
                                        <h2 className="text-2xl font-western text-red-500">BAR CLOSED</h2>
                                        <p className="text-slate-300 text-sm">Womp. Womp. The House ran out of money.</p>
                                    </>
                                ) : (
                                    <>
                                        <div className="text-green-400"><Icon name="DollarSign" size={48} /></div>
                                        <h2 className="text-2xl font-western">High-Stakes Bar Dice</h2>
                                        <div className="text-slate-300 text-xs md:text-sm max-w-md text-left space-y-2 bg-slate-800/50 p-4 rounded-lg">
                                            <p><span className="text-green-400 font-bold">START:</span> House & Patrons each start with ${HOUSE_START_MONEY}.</p>
                                            <p><span className="text-yellow-400 font-bold">CONTRIBUTE:</span> Everyone puts in ${CONTRIBUTION} to the Pot each round.</p>
                                            <p><span className="text-yellow-400 font-bold">WINNER:</span> Takes the entire Pot.</p>
                                            <p><span className="text-red-400 font-bold">LOSER:</span> Pays a fixed $20 penalty (Buys the Round).</p>
                                            <p className="border-t border-slate-700 pt-2"><span className="text-yellow-400 font-bold">Game End:</span> The House wins by bankrupting all four unique Patrons, or the House loses if House Funds reach $0.</p>
                                        </div>
                                    </>
                                )}
                                <button onClick={initializeGame} className="px-6 py-2 bg-yellow-600 hover:bg-yellow-500 text-black font-bold rounded shadow-lg uppercase tracking-wider transition-colors text-sm">
                                    {gameState === 'START' ? 'Open Bar' : 'Start New Game'}
                                </button>
                            </div>
                        ) : (
                            <div className={`glass-panel p-4 rounded-xl mt-2 border-t-4 transition-all duration-500 ${isPlayerTurn ? 'border-yellow-500 shadow-[0_0_20px_rgba(234,179,8,0.2)]' : 'border-slate-700 opacity-80 grayscale-[0.5]'}`}>
                                {/* Player Info */}
                                <div className="flex justify-between items-end mb-4">
                                    <div>
                                        <h2 className="text-lg font-bold text-white flex items-center gap-2">
                                            Your Roll
                                            {isPlayerTurn && <span className="text-[10px] bg-yellow-500 text-black px-2 py-0.5 rounded-full font-bold animate-pulse">YOUR TURN</span>}
                                        </h2>
                                        <div className="text-xs text-slate-400">
                                            Result: <span className="text-yellow-400">{currentHandDisplay ? HAND_NAMES[currentHandDisplay.rank] : 'Roll to Reveal'}</span>
                                        </div>
                                    </div>
                                    <div className="flex gap-1">
                                        <button title="House Perks are disabled." disabled className="p-1.5 rounded bg-slate-800 border border-slate-600 opacity-30 w-12 flex flex-col items-center">
                                            <span className="text-blue-400"><Icon name="RefreshCw" size={12} /></span>
                                            <span className="text-[9px] text-yellow-500">--</span>
                                        </button>
                                        <button title="House Perks are disabled." disabled className="p-1.5 rounded bg-slate-800 border border-slate-600 opacity-30 w-12 flex flex-col items-center">
                                            <span className="text-yellow-400"><Icon name="Star" size={12} /></span>
                                            <span className="text-[9px] text-yellow-500">--</span>
                                        </button>
                                    </div>
                                </div>

                                {/* Main Dice */}
                                <div className="flex justify-center gap-2 mb-6">
                                    {playerDice.map((val, idx) => <Die key={idx} value={val} held={heldDice[idx]} onClick={() => toggleDie(idx)} />)}
                                </div>

                                {/* Controls */}
                                <div className="flex justify-center gap-3">
                                    {gameState === 'ROLLING' && (
                                        <>
                                            {isPlayerTurn && rollsLeft > 0 ? (
                                                <button onClick={rollDice} className="btn-pulse px-6 py-3 bg-yellow-600 hover:bg-yellow-500 text-black font-bold rounded-full shadow-lg flex items-center gap-2 transition-transform transform active:scale-95">
                                                    <Icon name="RefreshCw" size={18} /> ROLL ({rollsLeft})
                                                </button>
                                            ) : (
                                                <div className="text-slate-500 font-bold italic py-2">
                                                    {isPlayerTurn ? "Out of rolls..." : "Waiting for turn..."}
                                                </div>
                                            )}
                                            
                                            {/* STAY BUTTON */}
                                            {isPlayerTurn && (rollsLeft < 3 || playerDice[0] !== 0) && (
                                                <button onClick={forceFinish} className="px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-full shadow-lg flex items-center gap-2 border border-slate-500 text-sm">
                                                    <Icon name="Check" size={18} /> FINISH
                                                </button>
                                            )}
                                        </>
                                    )}
                                    {gameState === 'ROUND_END' && (
                                        <button onClick={() => { startRound(); }} className="btn-pulse px-8 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-full shadow-lg flex items-center gap-2">
                                            Next Round <Icon name="TrendingUp" size={18} />
                                        </button>
                                    )}
                                </div>
                                <div className="text-center mt-3 text-[10px] text-slate-500">
                                    {isPlayerTurn ? "Click dice to hold. Click FINISH to pass turn." : "Watch your opponents roll."}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
