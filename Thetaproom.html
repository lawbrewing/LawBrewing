<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Law Brewing: The Game</title>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --wood-dark: #3e2723;
            --wood-light: #5d4037;
            --accent: #ffffff; /* White like the logo */
            --danger: #b71c1c;
            --card-bg: #fff;
            --ink: #000;
        }

        @import url('https://fonts.googleapis.com/css2?family=Rye&family=Courier+Prime:wght@400;700&display=swap');

        body {
            font-family: 'Courier Prime', monospace; /* Typewriter/Legal feel */
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            padding-bottom: 80px;
        }

        h1, h2, h3 { 
            font-family: 'Rye', serif; /* Western Font */
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 10px 0;
        }

        h1 { font-size: 2.5em; border-bottom: 2px solid white; display: inline-block; padding-bottom: 10px; }

        /* CONTAINERS */
        .screen {
            width: 100%; max-width: 600px; padding: 10px;
            box-sizing: border-box; display: none; animation: fadeIn 0.5s;
        }
        .active-screen { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* LOGO BADGE CSS */
        .sheriff-star {
            width: 100px; height: 100px; background: #000;
            border: 3px solid white; display: inline-flex;
            align-items: center; justify-content: center;
            border-radius: 50%; margin-bottom: 20px;
            position: relative;
            box-shadow: 0 0 0 5px black, 0 0 0 8px white;
        }
        .sheriff-star::after { content: '‚òÖ'; font-size: 50px; color: white; }

        /* BUTTONS */
        .btn-main {
            background: #000; color: #fff; border: 2px solid #fff;
            padding: 15px 25px; font-family: 'Rye', serif; font-size: 1.2em;
            cursor: pointer; border-radius: 5px; margin: 10px; width: 80%;
            transition: all 0.2s; text-transform: uppercase;
        }
        .btn-main:hover { background: #fff; color: #000; transform: scale(1.02); }
        .btn-secondary { width: auto; font-size: 0.9em; padding: 10px 20px; }
        .btn-small { 
            background: #222; color: white; border: 1px solid white;
            padding: 5px 10px; font-weight: bold; cursor: pointer; 
        }

        /* PADDLE & FLIGHT VISUALS */
        .paddle-container {
            display: flex; align-items: center; justify-content: center;
            margin: 10px 0;
        }
        
        .paddle {
            background: repeating-linear-gradient(90deg, #5d4037, #5d4037 10px, #4e342e 10px, #4e342e 20px);
            border: 2px solid #222;
            border-radius: 10px 0 0 10px;
            padding: 10px;
            display: flex; gap: 10px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            min-height: 100px; min-width: 260px;
        }
        
        .paddle-handle {
            width: 40px; height: 40px;
            background: #4e342e;
            border-radius: 0 10px 10px 0;
            border: 2px solid #222; border-left: none;
            display: flex; align-items: center; justify-content: center;
        }
        .hole { width: 10px; height: 10px; background: #000; border-radius: 50%; box-shadow: inset 0 0 3px white;}

        /* BEER GLASS VISUALS */
        .beer-glass {
            width: 50px; height: 80px;
            background: var(--beer-color, #f4c542);
            border: 2px solid rgba(255,255,255,0.6); border-top: none;
            border-radius: 0 0 8px 8px;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center;
            color: #000; font-weight: bold; font-family: 'Rye', serif;
            text-shadow: 0 0 2px white;
            box-shadow: inset -5px 0 10px rgba(0,0,0,0.2);
        }
        .beer-glass::before { /* Foam */
            content: ''; position: absolute; top: -5px; left: 0; right: 0;
            height: 10px; background: white; border-radius: 5px 5px 0 0;
        }
        .beer-label {
            background: white; padding: 2px 5px; border-radius: 3px; border: 1px solid black;
            font-size: 0.9em;
        }
        .beer-glass:hover { transform: scale(1.1); }
        .beer-glass.selected { border: 2px solid cyan; box-shadow: 0 0 10px cyan; }

        /* STANDARD CARD (HAND) */
        .card-container { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        .card {
            width: 60px; height: 90px; background: white; color: black;
            border-radius: 5px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-weight: bold;
            cursor: pointer; user-select: none; position: relative;
            border: 2px solid #ccc;
        }
        .card.red { color: #b71c1c; }
        .card.black { color: #000; }
        .card:hover { transform: translateY(-5px); border-color: white; }
        .card-corner { position: absolute; top: 2px; left: 4px; font-size: 0.7em; font-family: 'Courier Prime', monospace;}
        .card-center { font-size: 1.5em; }
        .card-hint { font-size: 0.5em; color: #555; position: absolute; bottom: 2px; text-transform: uppercase; font-family: sans-serif; text-align: center; width: 100%;}

        /* LOG */
        #log {
            height: 80px; overflow-y: auto; background: #111; border: 1px solid #fff;
            padding: 5px; font-size: 0.8em; text-align: left; margin: 10px 0; color: #fff;
            font-family: 'Courier Prime', monospace;
        }
        #log div { border-bottom: 1px solid #333; padding: 2px; }

        /* SCOREBOARD */
        .match-score {
            display: flex; justify-content: space-around; border: 2px solid white;
            padding: 10px; margin-bottom: 10px; background: #000;
        }
        .score-val { font-size: 1.5em; font-family: 'Rye', serif; }
        
        #cheat-sheet {
            position: fixed; bottom: 0; left: 0; right: 0; background: #000;
            border-top: 2px solid white; padding: 10px; display: none;
            justify-content: space-around; font-size: 0.8em; z-index: 100;
        }
        .legend-item b { color: white; margin-right: 5px; font-family: 'Rye', serif;}
        .legend-item { color: #ccc; }

        /* ANIMATIONS */
        .scan-line { width: 100%; height: 2px; background: white; animation: flash 1s infinite; margin: 10px 0; }
        @keyframes flash { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        
        /* MANUAL PAGE */
        .ref-card {
            background: white; color: black; padding: 15px; border: 2px solid #ccc;
            text-align: left;
        }
        .ref-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 0.9em; }
        .ref-table th { border-bottom: 2px solid black; text-align: left; }
        .ref-table td { border-bottom: 1px solid #ccc; padding: 4px 0; }

    </style>
</head>
<body>

    <div id="cheat-sheet">
        <div class="legend-item"><b>J</b>Draw 2, Disc 1</div>
        <div class="legend-item"><b>Q</b>Remove Opp</div>
        <div class="legend-item"><b>K</b>Opp Disc 2</div>
        <div class="legend-item"><b>A</b>Steal Brew</div>
    </div>

    <div id="landing-screen" class="screen active-screen">
        <div class="sheriff-star"></div>
        <h1>LAW BREWING</h1>
        <h3 style="font-size: 1em; margin-top: -10px;">The Card Game</h3>
        <br><br>
        <button class="btn-main" onclick="goToManualMode()">Rules & Tools</button>
        <button class="btn-main" onclick="startNewMatch()">Play vs. House</button>
    </div>

    <div id="manual-screen" class="screen">
        <button class="btn-main btn-secondary" onclick="goHome()">Back</button>
        <h2>The Rules</h2>
        <div class="match-score">
            <div>YOU<br><span id="manual-p-score" class="score-val">0</span></div>
            <div style="padding-top:10px; font-size:0.8em;">FIRST TO 3 WINS</div>
            <div>OPP<br><span id="manual-o-score" class="score-val">0</span></div>
        </div>
        <div style="margin-bottom:10px;">
            <button class="btn-small" onclick="modManualScore('p',1)">+ You</button>
            <button class="btn-small" onclick="modManualScore('o',1)">+ Opp</button>
            <button class="btn-small" onclick="modManualScore('reset',0)">Reset</button>
        </div>

        <div class="ref-card">
            <h3>THE TURN</h3>
            <ol style="padding-left:20px; margin:5px;">
                <li><b>Pour:</b> Draw 1 Card.</li>
                <li><b>Serve:</b> Play a Brew (2-10) to your Flight, Play a Patron (Face Card), or Waste.</li>
            </ol>
            <h3>PATRONS (Face Cards)</h3>
            <table class="ref-table">
                <tr><td><b>Jack</b></td><td>Regular: Draw 2, Discard 1.</td></tr>
                <tr><td><b>Queen</b></td><td>Barmaid: Remove 1 from opp Flight.</td></tr>
                <tr><td><b>King</b></td><td>Bouncer: Opponent discards 2.</td></tr>
                <tr><td><b>Ace</b></td><td>Tip Jar: Steal 1 Brew from opp Flight.</td></tr>
            </table>
            <h3>LAST CALL</h3>
            <p style="font-size:0.9em;">If you start turn with 4 Beers: Yell "Last Call!". Opponent gets 1 turn to stop you. If you still have 4, round ends.</p>
        </div>
        <br>
        <button class="btn-main" onclick="runTiebreaker('MANUAL')">Who is Cuter?</button>
    </div>

    <div id="tiebreaker-screen" class="screen">
        <h2>Cuteness Assessment</h2>
        <div id="scan-anim"><p>Scanning facial symmetry...</p><div class="scan-line"></div></div>
        <div id="tiebreaker-final" style="display:none;">
            <h3 id="tiebreaker-winner"></h3>
            <p id="tiebreaker-reason" style="font-family: 'Courier Prime';"></p>
            <button id="tiebreaker-continue-btn" class="btn-main">Proceed</button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button class="btn-small" onclick="if(confirm('Abandon Shift?')) goHome()">EXIT</button>
            <div style="font-family:'Rye'">
                YOU <span id="game-p-wins" style="font-size:1.2em">0</span> - <span id="game-c-wins" style="font-size:1.2em">0</span> HOUSE
            </div>
        </div>

        <div style="margin-top:10px; font-size:0.8em; text-align: left; padding-left: 20px;">HOUSE FLIGHT</div>
        <div class="paddle-container">
            <div class="paddle" id="cpu-flight"></div>
            <div class="paddle-handle"><div class="hole"></div></div>
        </div>
        <div style="font-size:0.8em; text-align:right;">House Hand: <span id="cpu-hand-count">3</span></div>

        <div id="log"></div>
        
        <div id="controls-area" style="background:#000; border: 1px solid white; padding:10px; margin:5px 0;">
            <div id="turn-indicator" style="font-weight:bold; font-family: 'Rye'; font-size: 1.2em;">Starting...</div>
            <div id="player-options" style="display:none; margin-top:5px;">
                <label style="cursor:pointer;"><input type="checkbox" id="waste-mode"> üóëÔ∏è WASTE MODE</label>
            </div>
        </div>

        <div style="font-size:0.8em; text-align: left; padding-left: 20px;">YOUR FLIGHT</div>
        <div class="paddle-container">
            <div class="paddle" id="player-flight"></div>
            <div class="paddle-handle"><div class="hole"></div></div>
        </div>

        <div class="zone" style="border:none; background:transparent;">
            <div id="player-hand" class="card-container"></div>
        </div>
    </div>

<script>
    // --- VISUAL CONFIG ---
    const SUITS = ['‚ô•', '‚ô¶', '‚ô£', '‚ô†'];
    const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
    
    // Beer Colors based on Rank (ABV/Roast style)
    function getBeerColor(rank) {
        const val = parseInt(rank);
        if (val <= 3) return '#fff9c4'; // Pale / Straw (2-3)
        if (val <= 5) return '#fdd835'; // Gold (4-5)
        if (val <= 7) return '#fb8c00'; // Amber / Copper (6-7)
        if (val <= 9) return '#5d4037'; // Brown (8-9)
        return '#212121'; // Stout / Black (10)
    }

    // --- NAVIGATION ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        document.getElementById(id).classList.add('active-screen');
        const sheet = document.getElementById('cheat-sheet');
        sheet.style.display = (id === 'game-screen') ? 'flex' : 'none';
    }
    function goHome() { showScreen('landing-screen'); }
    function goToManualMode() { showScreen('manual-screen'); }

    // --- SCOREBOARD ---
    let mPWins=0, mOWins=0;
    function modManualScore(who, amt) {
        if(who==='reset') { mPWins=0; mOWins=0; }
        else if(who==='p') { mPWins+=amt; if(mPWins>3) mPWins=3; }
        else { mOWins+=amt; if(mOWins>3) mOWins=3; }
        document.getElementById('manual-p-score').innerText = mPWins;
        document.getElementById('manual-o-score').innerText = mOWins;
    }

    // --- TIEBREAKER ---
    function runTiebreaker(ctx) {
        showScreen('tiebreaker-screen');
        document.getElementById('scan-anim').style.display='block';
        document.getElementById('tiebreaker-final').style.display='none';
        
        setTimeout(() => {
            document.getElementById('scan-anim').style.display='none';
            document.getElementById('tiebreaker-final').style.display='block';
            
            let isPlayer = Math.random() > 0.5;
            let winnerName = isPlayer ? "You" : (ctx === 'GAME' ? "The House" : "Opponent");
            
            let reasons = isPlayer 
                ? ["are radiating charm.", "have better hair today.", "are objectively cuter.", "have a winning smile."]
                : ["is radiating charm.", "has better hair today.", "is objectively cuter.", "has a winning smile."];
            
            let reason = reasons[Math.floor(Math.random() * reasons.length)];
            let winText = isPlayer ? "You are Cuter!" : `${winnerName} is Cuter!`;
            
            document.getElementById('tiebreaker-winner').innerText = winText;
            document.getElementById('tiebreaker-reason').innerText = `Because ${winnerName} ${reason}`;
            
            document.getElementById('tiebreaker-continue-btn').onclick = () => {
                if(ctx === 'MANUAL') showScreen('manual-screen');
                else startShift(isPlayer ? 'PLAYER' : 'CPU');
            };
        }, 1500);
    }

    // --- GAME STATE ---
    let matchPWins=0, matchCWins=0;
    let deck=[], pHand=[], cHand=[], pFlight=[], cFlight=[];
    let turn="", gameState="IDLE", lastCallCaller=null, pendingAction=null;

    class Card {
        constructor(r, s) {
            this.r = r; this.s = s;
            this.isBrew = !isNaN(parseInt(r));
            this.val = this.isBrew ? parseInt(r) : 0;
            this.uid = Math.random().toString(36);
        }
        getEffectName() {
            if(this.r==='J') return "DRAW 2 DISC 1";
            if(this.r==='Q') return "REMOVE OPP";
            if(this.r==='K') return "OPP DISC 2";
            if(this.r==='A') return "STEAL BREW";
            return "";
        }
    }

    function startNewMatch() { matchPWins=0; matchCWins=0; updateMatchUI(); runTiebreaker('GAME'); }
    function updateMatchUI() { document.getElementById('game-p-wins').innerText=matchPWins; document.getElementById('game-c-wins').innerText=matchCWins; }
    function log(msg) { 
        const d=document.getElementById('log'); 
        d.innerHTML += `<div>> ${msg.toUpperCase()}</div>`; d.scrollTop=d.scrollHeight; 
    }

    function startShift(starter) {
        showScreen('game-screen');
        deck=[]; for(let s of SUITS) for(let r of RANKS) deck.push(new Card(r,s));
        deck.sort(()=>Math.random()-0.5);
        
        pHand=[]; cHand=[];
        for(let i=0; i<3; i++) pHand.push(deck.pop());
        for(let i=0; i<3; i++) cHand.push(deck.pop());
        
        pFlight=[]; cFlight=[]; lastCallCaller=null;
        document.getElementById('log').innerHTML="";
        log(`Shift Started. ${starter} pours first.`);
        startTurn(starter);
    }

    function startTurn(who) {
        turn = who;
        
        // Last Call Resolution
        if(lastCallCaller !== null && turn === lastCallCaller) {
            let flight = (turn==='PLAYER') ? pFlight : cFlight;
            if(flight.length===4) { endShift(); return; }
            else { log(`üö´ Last Call Broken! Play continues.`); lastCallCaller=null; }
        }

        // Last Call Trigger
        let myFlight = (who==='PLAYER') ? pFlight : cFlight;
        if(myFlight.length===4 && lastCallCaller===null) {
            lastCallCaller = who;
            log(`üîî ${who} yells "Last Call!"`);
            renderGame();
            setTimeout(()=>startTurn(who==='PLAYER'?'CPU':'PLAYER'), 2000);
            return;
        }

        document.getElementById('turn-indicator').innerText = `${who==='PLAYER'?'YOUR':"HOUSE"} TURN`;
        document.getElementById('turn-indicator').style.color = who==='PLAYER'?'white':'#aaa';

        if(deck.length) {
            let c = deck.pop();
            if(who==='PLAYER') pHand.push(c); else cHand.push(c);
        }
        renderGame();

        if(who==='PLAYER') {
            gameState='PLAY'; document.getElementById('player-options').style.display='block';
            document.getElementById('waste-mode').checked=false;
        } else {
            document.getElementById('player-options').style.display='none';
            setTimeout(cpuTurn, 1500);
        }
    }

    // --- AI ---
    function cpuTurn() {
        let played = false;

        // 1. Break Last Call
        if(lastCallCaller === 'PLAYER' && pFlight.length === 4) {
            let qIdx = cHand.findIndex(c => c.r === 'Q');
            if(qIdx !== -1) {
                cHand.splice(qIdx, 1); pFlight.pop();
                log(`üö® House breaks Last Call with Queen!`);
                renderGame(); startTurn('PLAYER'); return;
            }
            let aIdx = cHand.findIndex(c => c.r === 'A');
            if(aIdx !== -1 && cFlight.length < 4) {
                cHand.splice(aIdx, 1); cFlight.push(pFlight.pop());
                log(`üö® House breaks Last Call with Ace!`);
                renderGame(); startTurn('PLAYER'); return;
            }
        }

        // 2. Smart Steal
        let aIdx = cHand.findIndex(c => c.r === 'A');
        if(!played && aIdx !== -1 && pFlight.length > 0 && cFlight.length < 4) {
            let bestVal = 0; let target = -1;
            pFlight.forEach((c, i) => { if(c.val > bestVal) { bestVal = c.val; target = i; } });
            if(bestVal >= 9) {
                cHand.splice(aIdx, 1); cFlight.push(pFlight.splice(target, 1)[0]);
                log(`ü§ñ House steals your ${bestVal} with Ace!`); played = true;
            }
        }

        // 3. Play High Brew (8+)
        if(!played) {
            let bIdx = cHand.findIndex(c => c.isBrew && c.val >= 8);
            if(bIdx !== -1 && cFlight.length < 4) {
                let c = cHand.splice(bIdx, 1)[0]; cFlight.push(c);
                log(`ü§ñ House pours ${c.r}${c.s}`); played = true;
            }
        }

        // 4. Any Play
        if(!played) {
            let anyB = cHand.findIndex(c => c.isBrew);
            if(anyB !== -1 && cFlight.length < 4) {
                let c = cHand.splice(anyB, 1)[0]; cFlight.push(c);
                log(`ü§ñ House pours ${c.r}${c.s}`); played = true;
            } else if (cHand.length > 0) {
                 // Try effects or waste
                 let qIdx = cHand.findIndex(c => c.r === 'Q');
                 if(qIdx !== -1 && pFlight.length > 0) {
                     cHand.splice(qIdx, 1); pFlight.pop(); log("ü§ñ House plays Queen.");
                 } else {
                     let w = cHand.shift(); log(`ü§ñ House wastes ${w.r}${w.s}`);
                 }
            }
        }
        renderGame();
        startTurn('PLAYER');
    }

    // --- PLAYER ---
    window.cardAction = function(loc, uid) {
        if(turn !== 'PLAYER') return;
        
        // HAND INTERACTION
        if(loc==='HAND' && gameState==='PLAY') {
            const idx = pHand.findIndex(c => c.uid === uid);
            const card = pHand[idx];
            
            if(document.getElementById('waste-mode').checked) {
                pHand.splice(idx,1); log(`Wasted ${card.r}${card.s}`); nextTurn(); return;
            }
            
            if(card.isBrew) {
                if(pFlight.length<4) { 
                    pHand.splice(idx,1); pFlight.push(card); 
                    log(`Poured ${card.r}${card.s}`); nextTurn(); 
                } else alert("Paddle Full!");
            } else {
                if(card.r==='A' && (cFlight.length===0 || pFlight.length===4)) { alert("Cannot steal."); return; }
                if(card.r==='Q' && cFlight.length===0) { alert("Nothing to remove."); return; }
                handlePatron(card, idx);
            }
        }
        // DISCARD INTERACTION
        else if(loc==='HAND' && gameState==='DISCARD') {
            pHand.splice(pHand.findIndex(c=>c.uid===uid),1); log("Discarded."); nextTurn();
        }
        // TARGETING (Opponent Flight)
        else if(loc==='CPU' && gameState==='TARGET') {
            if(pendingAction) pendingAction(cFlight.findIndex(c=>c.uid===uid));
        }
    }

    function handlePatron(c, i) {
        if(c.r==='J') { 
            pHand.splice(i,1); if(deck.length) pHand.push(deck.pop()); if(deck.length) pHand.push(deck.pop());
            log("Jack: Draw 2, Disc 1."); gameState='DISCARD'; renderGame();
        }
        else if(c.r==='K') {
            pHand.splice(i,1); if(cHand.length) cHand.pop(); if(cHand.length) cHand.pop();
            log("King: House discards 2."); nextTurn();
        }
        else if(c.r==='Q') {
            pHand.splice(i,1); log("Select beer to Remove."); gameState='TARGET';
            pendingAction=(t)=>{ cFlight.splice(t,1); log("Removed beer."); nextTurn(); }; renderGame();
        }
        else if(c.r==='A') {
            pHand.splice(i,1); log("Select beer to Steal."); gameState='TARGET';
            pendingAction=(t)=>{ pFlight.push(cFlight.splice(t,1)[0]); log("Stole beer."); nextTurn(); }; renderGame();
        }
    }

    function nextTurn() { gameState='IDLE'; renderGame(); startTurn('CPU'); }

    // --- RENDER ---
    function renderGame() {
        // Render Hand (Standard Cards)
        const rCard = (c) => {
            return `<div class="card ${['‚ô•','‚ô¶'].includes(c.s)?'red':'black'}" 
                    onclick="cardAction('HAND','${c.uid}')">
                    <div class="card-corner">${c.r}<br>${c.s}</div>
                    <div class="card-center">${c.s}</div>
                    <div class="card-hint">${c.getEffectName()}</div>
                    </div>`;
        };
        
        // Render Flight (Beer Glasses)
        const rBeer = (c, loc) => {
            const clk = (loc==='CPU' && gameState==='TARGET');
            const beerColor = getBeerColor(c.r);
            const isDark = parseInt(c.r) >= 8;
            return `<div class="beer-glass" 
                    style="--beer-color:${beerColor}; color:${isDark?'white':'black'}; text-shadow:${isDark?'0 0 2px black':'0 0 2px white'}; ${clk?'border-color:cyan; box-shadow:0 0 10px cyan':''}"
                    onclick="cardAction('${loc}','${c.uid}')">
                    ${c.r}
                    <div class="beer-label" style="position:absolute; bottom:5px;">${c.s}</div>
                    </div>`;
        };

        document.getElementById('player-flight').innerHTML = pFlight.map(c=>rBeer(c,'P_FLIGHT')).join('');
        document.getElementById('cpu-flight').innerHTML = cFlight.map(c=>rBeer(c,'CPU')).join('');
        document.getElementById('player-hand').innerHTML = pHand.map(c=>rCard(c)).join('');
        document.getElementById('cpu-hand-count').innerText = cHand.length;
    }

    // --- SCORING ---
    function calcScore(f) {
        if(!f.length) return 0;
        let s=f.reduce((a,b)=>a+b.val,0);
        if(f.length===4) {
            if(new Set(f.map(c=>c.s)).size===1) s+=20;
            else { let r=f.filter(c=>['‚ô•','‚ô¶'].includes(c.s)).length; if(r===0||r===4) s+=10; }
        }
        return s;
    }

    function endShift() {
        let ps=calcScore(pFlight), cs=calcScore(cFlight);
        let msg = `SHIFT OVER\n\nYou: ${ps} | House: ${cs}\n`;
        if(ps>cs) { msg+="üèÜ YOU WIN!"; matchPWins++; }
        else if(cs>ps) { msg+="üíÄ HOUSE WINS."; matchCWins++; }
        else msg+="ü§ù TIE.";
        
        updateMatchUI();
        
        // Small delay to allow UI to update before alert
        setTimeout(() => {
            alert(msg);
            if(matchPWins>=3) { if(confirm("YOU WON THE MATCH! Play again?")) startNewMatch(); else goHome(); }
            else if(matchCWins>=3) { if(confirm("HOUSE WON THE MATCH. Retry?")) startNewMatch(); else goHome(); }
            else startShift(ps>cs?'PLAYER':(cs>ps?'CPU':(Math.random()>.5?'PLAYER':'CPU')));
        }, 100);
    }
</script>
</body>
</html>
