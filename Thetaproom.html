<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Taproom: Law Brewing v13</title>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --highlight: #00bcd4;
            --gold: #ffb300;
        }

        @import url('https://fonts.googleapis.com/css2?family=Rye&family=Courier+Prime:wght@400;700&display=swap');

        body {
            font-family: 'Courier Prime', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            padding-bottom: 80px;
            user-select: none;
        }

        h1, h2, h3 { 
            font-family: 'Rye', serif;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 10px 0;
        }

        h1 { font-size: 2em; border-bottom: 2px solid white; display: inline-block; padding-bottom: 10px; line-height: 1.2; margin-top: 30px;}

        /* CONTAINERS */
        .screen { width: 100%; max-width: 600px; padding: 10px; box-sizing: border-box; display: none; animation: fadeIn 0.5s; }
        .active-screen { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* BUTTONS */
        .btn-main {
            background: #000; color: #fff; border: 2px solid #fff;
            padding: 15px 25px; font-family: 'Rye', serif; font-size: 1.1em;
            cursor: pointer; border-radius: 5px; margin: 10px; width: 80%;
            transition: all 0.2s; text-transform: uppercase;
        }
        .btn-main:hover { background: #fff; color: #000; transform: scale(1.02); }
        .btn-secondary { width: auto; font-size: 0.9em; padding: 10px 20px; }
        .btn-small { background: #222; color: white; border: 1px solid white; padding: 5px 10px; font-weight: bold; cursor: pointer; }
        
        #last-call-btn {
            background: var(--gold); color: black; border: 2px solid white;
            font-family: 'Rye', serif; font-size: 1.2em; padding: 10px 20px;
            animation: pulse 1.5s infinite; cursor: pointer; display: none;
            margin-bottom: 10px;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* PADDLE & FLIGHT VISUALS */
        .paddle-container {
            display: flex; align-items: center; justify-content: center;
            margin: 10px 0;
        }
        .paddle {
            background: repeating-linear-gradient(90deg, #5d4037, #5d4037 10px, #4e342e 10px, #4e342e 20px);
            border: 2px solid #222; border-radius: 10px 0 0 10px;
            padding: 10px; display: flex; gap: 10px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            min-height: 100px; min-width: 260px;
        }
        .paddle-handle {
            width: 40px; height: 40px; background: #4e342e;
            border-radius: 0 10px 10px 0; border: 2px solid #222; border-left: none;
            display: flex; align-items: center; justify-content: center;
        }
        .hole { width: 10px; height: 10px; background: #000; border-radius: 50%; box-shadow: inset 0 0 3px white;}

        .flight-score-display {
            font-family: 'Rye', serif; color: var(--gold); font-size: 1.2em;
            text-align: right; min-width: 80px;
        }

        /* BEER GLASS VISUALS */
        .beer-glass {
            width: 50px; height: 80px;
            background: var(--beer-color, #f4c542);
            border: 2px solid rgba(255,255,255,0.6); border-top: none;
            border-radius: 0 0 8px 8px; position: relative;
            cursor: pointer; transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center;
            color: #000; font-weight: bold; font-family: 'Rye', serif;
            text-shadow: 0 0 2px white;
            box-shadow: inset -5px 0 10px rgba(0,0,0,0.2);
        }
        .beer-glass::before { content: ''; position: absolute; top: -5px; left: 0; right: 0; height: 10px; background: white; border-radius: 5px 5px 0 0; }
        
        .beer-label { 
            background: white; padding: 2px 4px; border-radius: 3px; border: 1px solid black; 
            font-size: 1.2em; line-height: 1; position: absolute; bottom: 5px;
            width: 30px; text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .suit-red { color: #d32f2f; text-shadow: none; }
        .suit-black { color: #212121; text-shadow: none; }

        .beer-glass:hover { transform: scale(1.1); }
        .beer-glass.selected { border: 3px solid var(--highlight); box-shadow: 0 0 15px var(--highlight); transform: translateY(-10px); }

        /* CARDS */
        .card-container { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        .card {
            width: 60px; height: 90px; background: white; color: black;
            border-radius: 5px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-weight: bold;
            cursor: pointer; position: relative; border: 2px solid #ccc;
        }
        .card.red { color: #b71c1c; }
        .card.black { color: #000; }
        .card.selected { border: 3px solid var(--highlight); box-shadow: 0 0 10px var(--highlight); }
        .card:hover { transform: translateY(-5px); border-color: black; }
        
        .card-corner { position: absolute; top: 2px; left: 4px; font-size: 0.7em; font-family: 'Courier Prime', monospace; line-height: 1; text-align: center; }
        .card-corner.bottom { top: auto; bottom: 2px; left: auto; right: 4px; transform: rotate(180deg); }
        
        /* LOG */
        #log { height: 80px; overflow-y: auto; background: #111; border: 1px solid #fff; padding: 5px; font-size: 0.8em; text-align: left; margin: 10px 0; color: #fff; }
        #log div { border-bottom: 1px solid #333; padding: 2px; }

        /* SCOREBOARD & FOOTER */
        .match-score { display: flex; justify-content: space-around; border: 2px solid white; padding: 10px; margin-bottom: 10px; background: #000; }
        .score-val { font-size: 1.5em; font-family: 'Rye', serif; }
        
        #cheat-sheet {
            position: fixed; bottom: 0; left: 0; right: 0; background: #000;
            border-top: 2px solid white; padding: 10px; display: none;
            justify-content: space-around; font-size: 0.8em; z-index: 100;
        }
        .legend-item b { color: white; margin-right: 5px; font-family: 'Rye', serif;}
        .legend-item { color: #ccc; }

        .scan-line { width: 100%; height: 2px; background: white; animation: flash 1s infinite; margin: 10px 0; }
        @keyframes flash { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        
        /* MANUAL PAGE */
        .ref-card { background: white; color: black; padding: 15px; border: 2px solid #ccc; text-align: left; }
        .ref-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 0.9em; }
        .ref-table th { border-bottom: 2px solid black; text-align: left; padding: 5px 0;}
        .ref-table td { border-bottom: 1px solid #ccc; padding: 4px 0; }

    </style>
</head>
<body>

    <div id="cheat-sheet">
        <div class="legend-item"><b>J</b>Draw 2, Disc 1</div>
        <div class="legend-item"><b>Q</b>Remove Opp</div>
        <div class="legend-item"><b>K</b>Opp Disc 2</div>
        <div class="legend-item"><b>A</b>Steal Brew</div>
    </div>

    <div id="landing-screen" class="screen active-screen">
        <h1>THE TAPROOM</h1>
        <h3 style="font-size: 1em; margin-top: -10px;">A Beer Flight Card Game</h3>
        <br><br>
        <button class="btn-main" onclick="goToManualMode()">Rules & Tools</button>
        <button class="btn-main" onclick="startNewMatch()">Play vs. House</button>
    </div>

    <div id="manual-screen" class="screen">
        <button class="btn-main btn-secondary" onclick="goHome()">Back</button>
        <h2>The Rules</h2>
        <div class="match-score">
            <div>YOU<br><span id="manual-p-score" class="score-val">0</span></div>
            <div style="padding-top:10px; font-size:0.8em;">FIRST TO 3 WINS</div>
            <div>OPP<br><span id="manual-o-score" class="score-val">0</span></div>
        </div>
        <div style="margin-bottom:10px;">
            <button class="btn-small" onclick="modManualScore('p',1)">+ You</button>
            <button class="btn-small" onclick="modManualScore('o',1)">+ Opp</button>
            <button class="btn-small" onclick="modManualScore('reset',0)">Reset</button>
        </div>

        <div class="ref-card">
            <h3>THE TURN</h3>
            <ol style="padding-left:20px; margin:5px;">
                <li><b>1. The Pour:</b> Draw 1 Card.</li>
                <li><b>2. The Serve:</b> Do ONE of the following:
                    <ul>
                        <li><b>Play a Brew (2-10):</b> Place in Flight (Max 4).</li>
                        <li><b>Play a Patron (J, Q, K, A):</b> Discard for effect.</li>
                        <li><b>Waste:</b> Discard 1 card from hand.</li>
                    </ul>
                </li>
            </ol>
            
            <h3>THE MENU (Discard for Effect)</h3>
            <table class="ref-table">
                <tr><th>Card</th><th>Name</th><th>Effect</th></tr>
                <tr><td><b>Jack</b></td><td>The Regular</td><td>Draw 2, Discard 1.</td></tr>
                <tr><td><b>Queen</b></td><td>The Barmaid</td><td>Remove 1 card from opp. Flight.</td></tr>
                <tr><td><b>King</b></td><td>The Bouncer</td><td>Opp. discards 2 cards (random).</td></tr>
                <tr><td><b>Ace</b></td><td>The Tip Jar</td><td>Steal 1 Brew from opp. Flight.</td></tr>
            </table>

            <h3>SCORING & WINNING</h3>
            <ul>
                <li><b>Brews (2-10):</b> Face Value.</li>
                <li><b>Bonuses (Full Flight):</b> +10 (All same Color) | +20 (All same Suit).</li>
                <li><b>Victory:</b> Highest Score wins Shift. Win 3 Shifts.</li>
            </ul>

            <h3>ENDING THE ROUND</h3>
            <p style="font-size:0.9em;"><b>Last Call:</b> Start turn with 4 Cards in Flight -> Yell "Last Call!". Opponent gets 1 final turn.</p>
            <p style="text-align:center; font-style:italic; margin-top:5px;">Remember: The cute player goes first!</p>
        </div>
        <br>
        <button class="btn-main" onclick="runTiebreaker('MANUAL')">Who is Cuter?</button>
    </div>

    <div id="tiebreaker-screen" class="screen">
        <h2>Cuteness Assessment</h2>
        <div id="scan-anim"><p>Scanning facial symmetry...</p><div class="scan-line"></div></div>
        <div id="tiebreaker-final" style="display:none;">
            <h3 id="tiebreaker-winner"></h3>
            <p id="tiebreaker-reason" style="font-family: 'Courier Prime';"></p>
            <button id="tiebreaker-continue-btn" class="btn-main">Proceed</button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button class="btn-small" onclick="if(confirm('Abandon Shift?')) goHome()">EXIT</button>
            <div style="font-family:'Rye'">
                YOU <span id="game-p-wins" style="font-size:1.2em">0</span> - <span id="game-c-wins" style="font-size:1.2em">0</span> HOUSE
            </div>
        </div>

        <div style="display:flex; justify-content: space-between; align-items: flex-end; padding: 0 20px; margin-top:10px;">
            <div style="font-size:0.8em;">HOUSE FLIGHT</div>
            <div class="flight-score-display">Score: <span id="cpu-current-score">0</span></div>
        </div>
        <div class="paddle-container">
            <div class="paddle" id="cpu-flight"></div>
            <div class="paddle-handle"><div class="hole"></div></div>
        </div>
        <div style="font-size:0.8em; text-align:right;">House Hand: <span id="cpu-hand-count">3</span></div>

        <div id="log"></div>
        
        <div id="controls-area" style="background:#000; border: 1px solid white; padding:10px; margin:5px 0;">
            <div id="turn-indicator" style="font-weight:bold; font-family: 'Rye'; font-size: 1.2em;">Starting...</div>
            <button id="last-call-btn" onclick="triggerLastCall()">üîî CALL LAST CALL</button>
            <div id="player-options" style="display:none; margin-top:5px;">
                <label style="cursor:pointer;"><input type="checkbox" id="waste-mode"> üóëÔ∏è WASTE MODE</label>
            </div>
        </div>

        <div style="display:flex; justify-content: space-between; align-items: flex-end; padding: 0 20px;">
            <div style="font-size:0.8em;">YOUR FLIGHT</div>
            <div class="flight-score-display">Score: <span id="current-score">0</span></div>
        </div>
        <div class="paddle-container">
            <div class="paddle" id="player-flight"></div>
            <div class="paddle-handle"><div class="hole"></div></div>
        </div>

        <div class="zone" style="border:none; background:transparent;">
            <div id="player-hand" class="card-container"></div>
        </div>
    </div>

<script>
    // --- VISUAL CONFIG ---
    const SUITS = ['‚ô•', '‚ô¶', '‚ô£', '‚ô†'];
    const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
    
    // Distinct Beer Colors for every number 2-10
    function getBeerColor(rank) {
        const r = parseInt(rank);
        if(isNaN(r)) return '#fff';
        const colors = {
            2: '#faf4d4', 3: '#fff59d', 4: '#ffe082', 5: '#ffca28',
            6: '#ffb300', 7: '#fb8c00', 8: '#8d6e63', 9: '#5d4037', 10: '#212121'
        };
        return colors[r] || '#f4c542';
    }

    // --- NAVIGATION ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        document.getElementById(id).classList.add('active-screen');
        const sheet = document.getElementById('cheat-sheet');
        sheet.style.display = (id === 'game-screen') ? 'flex' : 'none';
    }
    function goHome() { showScreen('landing-screen'); }
    function goToManualMode() { showScreen('manual-screen'); }

    // --- SCOREBOARD ---
    let mPWins=0, mOWins=0;
    function modManualScore(who, amt) {
        if(who==='reset') { mPWins=0; mOWins=0; }
        else if(who==='p') { mPWins+=amt; if(mPWins>3) mPWins=3; }
        else { mOWins+=amt; if(mOWins>3) mOWins=3; }
        document.getElementById('manual-p-score').innerText = mPWins;
        document.getElementById('manual-o-score').innerText = mOWins;
    }

    // --- TIEBREAKER ---
    function runTiebreaker(ctx) {
        showScreen('tiebreaker-screen');
        document.getElementById('scan-anim').style.display='block';
        document.getElementById('tiebreaker-final').style.display='none';
        
        setTimeout(() => {
            document.getElementById('scan-anim').style.display='none';
            document.getElementById('tiebreaker-final').style.display='block';
            let isPlayer = Math.random() > 0.5;
            let winnerName = isPlayer ? "You" : (ctx === 'GAME' ? "The House" : "Opponent");
            let reasons = isPlayer 
                ? ["are radiating charm.", "have better hair.", "are objectively cuter.", "have a winning smile."]
                : ["is radiating charm.", "has better hair.", "is objectively cuter.", "has a winning smile."];
            
            let reason = reasons[Math.floor(Math.random() * reasons.length)];
            let winText = isPlayer ? "You are Cuter!" : `${winnerName} is Cuter!`;
            
            document.getElementById('tiebreaker-winner').innerText = winText;
            document.getElementById('tiebreaker-reason').innerText = `Because ${winnerName} ${reason}`;
            
            document.getElementById('tiebreaker-continue-btn').onclick = () => {
                if(ctx === 'MANUAL') showScreen('manual-screen');
                else startShift(isPlayer ? 'PLAYER' : 'CPU');
            };
        }, 1500);
    }

    // --- GAME STATE ---
    let matchPWins=0, matchCWins=0;
    let deck=[], pHand=[], cHand=[], pFlight=[], cFlight=[];
    let turn="", gameState="IDLE", lastCallCaller=null, pendingAction=null, swapSourceIdx=null;
    let tempStolenCard = null;

    class Card {
        constructor(r, s) {
            this.r = r; this.s = s;
            this.isBrew = !isNaN(parseInt(r));
            this.val = this.isBrew ? parseInt(r) : 0;
            this.uid = Math.random().toString(36);
        }
        getEffectName() {
            if(this.r==='J') return "DRAW 2 DISC 1";
            if(this.r==='Q') return "REMOVE OPP";
            if(this.r==='K') return "OPP DISC 2";
            if(this.r==='A') return "STEAL BREW";
            return "";
        }
    }

    function startNewMatch() { matchPWins=0; matchCWins=0; updateMatchUI(); runTiebreaker('GAME'); }
    function updateMatchUI() { document.getElementById('game-p-wins').innerText=matchPWins; document.getElementById('game-c-wins').innerText=matchCWins; }
    function log(msg) { 
        const d=document.getElementById('log'); 
        d.innerHTML += `<div>> ${msg.toUpperCase()}</div>`; d.scrollTop=d.scrollHeight; 
    }

    function startShift(starter) {
        showScreen('game-screen');
        deck=[]; for(let s of SUITS) for(let r of RANKS) deck.push(new Card(r,s));
        deck.sort(()=>Math.random()-0.5);
        pHand=[]; cHand=[];
        for(let i=0; i<3; i++) pHand.push(deck.pop());
        for(let i=0; i<3; i++) cHand.push(deck.pop());
        pFlight=[]; cFlight=[]; lastCallCaller=null;
        document.getElementById('log').innerHTML="";
        log(`Shift Started. ${starter} pours first.`);
        startTurn(starter);
    }

    function startTurn(who) {
        turn = who;
        if(lastCallCaller !== null && turn === lastCallCaller) {
            let flight = (turn==='PLAYER') ? pFlight : cFlight;
            if(flight.length===4) { endShift(); return; }
            else { log(`üö´ Last Call Broken! Play continues.`); lastCallCaller=null; }
        }

        document.getElementById('turn-indicator').innerText = `${who==='PLAYER'?'YOUR':"HOUSE"} TURN`;
        document.getElementById('turn-indicator').style.color = who==='PLAYER'?'white':'#aaa';
        document.getElementById('last-call-btn').style.display = 'none';

        if(deck.length) {
            let c = deck.pop();
            if(who==='PLAYER') pHand.push(c); else cHand.push(c);
        }

        if(who === 'PLAYER' && pFlight.length === 4 && lastCallCaller === null) {
            document.getElementById('last-call-btn').style.display = 'inline-block';
        }

        renderGame();

        if(who==='PLAYER') {
            gameState='PLAY'; 
            document.getElementById('player-options').style.display='block';
            document.getElementById('waste-mode').checked=false;
        } else {
            document.getElementById('player-options').style.display='none';
            setTimeout(cpuTurn, 1500);
        }
    }

    function triggerLastCall() {
        if(turn === 'PLAYER' && pFlight.length === 4) {
            lastCallCaller = 'PLAYER';
            document.getElementById('last-call-btn').style.display='none';
            log(`üîî YOU YELL "LAST CALL!"`);
            renderGame();
            setTimeout(()=>startTurn('CPU'), 1500);
        }
    }

    // --- SMART AI WITH BONUS LOGIC ---
    function cpuTurn() {
        let played = false;

        // 1. Break Player Last Call
        if(lastCallCaller === 'PLAYER' && pFlight.length === 4) {
            let qIdx = cHand.findIndex(c => c.r === 'Q');
            if(qIdx !== -1) {
                cHand.splice(qIdx, 1); pFlight.pop();
                log(`üö® House breaks Last Call with Queen!`);
                renderGame(); startTurn('PLAYER'); return;
            }
            let aIdx = cHand.findIndex(c => c.r === 'A');
            if(aIdx !== -1 && cFlight.length < 4) {
                cHand.splice(aIdx, 1); cFlight.push(pFlight.pop());
                log(`üö® House breaks Last Call with Ace!`);
                renderGame(); startTurn('PLAYER'); return;
            }
        }

        // 2. Decide: Call Last Call?
        if(cFlight.length === 4 && lastCallCaller === null) {
            let score = calcScore(cFlight);
            // Only call if score > 25 (likely flush/high cards) or if opponent is weak
            let opponentWeak = pFlight.length < 2 || calcScore(pFlight) < 15;
            if(score >= 25 || opponentWeak) {
                lastCallCaller = 'CPU';
                log(`üîî House yells "LAST CALL!" (Score: ${score})`);
                renderGame();
                setTimeout(()=>startTurn('PLAYER'), 1500);
                return;
            }
        }

        // 3. DEFENSE (Queen/Barmaid) - Break Player Bonuses
        if(!played) {
            let qIdx = cHand.findIndex(c => c.r === 'Q');
            if(qIdx !== -1 && pFlight.length >= 3) {
                // Check for Flush Threat
                let pSuits = pFlight.map(c => c.s);
                let dominantSuit = pSuits.sort((a,b) => pSuits.filter(v => v===a).length - pSuits.filter(v => v===b).length).pop();
                let count = pSuits.filter(s => s === dominantSuit).length;
                
                if(count >= 3) {
                    // Destroy one of them
                    let target = pFlight.findIndex(c => c.s === dominantSuit);
                    cHand.splice(qIdx, 1); pFlight.splice(target, 1);
                    log(`ü§ñ House breaks your Flush with Queen!`); played = true;
                }
            }
        }

        // 4. OFFENSE (Play Brew) - Chase Bonuses
        if(!played && cFlight.length < 4) {
            // Find Dominant Suit in Hand + Flight
            let mySuits = [...cFlight, ...cHand.filter(c=>c.isBrew)].map(c => c.s);
            if(mySuits.length > 0) {
                 let domSuit = mySuits.sort((a,b) => mySuits.filter(v => v===a).length - mySuits.filter(v => v===b).length).pop();
                 
                 // Look for match in hand
                 let matchIdx = cHand.findIndex(c => c.isBrew && c.s === domSuit);
                 
                 // Prioritize playing matching suit (even if low value)
                 if(matchIdx !== -1) {
                     let c = cHand.splice(matchIdx, 1)[0];
                     cFlight.push(c);
                     log(`ü§ñ House pours ${c.r}${c.s} (Building Bonus)`); played = true;
                 }
            }
        }

        // 5. Upgrade Flight (Swap low card for better)
        if(!played && cFlight.length === 4) {
            let lowestVal = 99; let lowIdx = -1;
            cFlight.forEach((c, i) => { if(c.val < lowestVal) { lowestVal = c.val; lowIdx = i; } });
            
            // Check hand for improvement matching suit
            let domSuit = cFlight[0].s; 
            let flushCount = cFlight.filter(c => c.s === domSuit).length;
            
            let bestIdx = -1;
            
            // If flush active, only swap for same suit higher value
            if(flushCount === 4) {
                 bestIdx = cHand.findIndex(c => c.isBrew && c.s === domSuit && c.val > lowestVal);
            } else {
                 // Swap for higher value
                 bestIdx = cHand.findIndex(c => c.isBrew && c.val > lowestVal);
            }

            if(bestIdx !== -1) {
                let newC = cHand.splice(bestIdx, 1)[0];
                let oldC = cFlight.splice(lowIdx, 1, newC)[0];
                log(`ü§ñ House upgrades: Swaps ${oldC.r} for ${newC.r}.`);
                played = true;
            }
        }

        // 6. Fallback (Play High or Waste)
        if(!played) {
            // Play any high brew
            let bIdx = cHand.findIndex(c => c.isBrew && c.val >= 6 && cFlight.length < 4);
            if(bIdx !== -1) {
                let c = cHand.splice(bIdx, 1)[0]; cFlight.push(c);
                log(`ü§ñ House pours ${c.r}${c.s}`); played = true;
            } 
            else if (cHand.length > 0) {
                // Waste
                let w = cHand.shift(); 
                log(`ü§ñ House wastes ${w.r}${w.s}`); played = true;
            }
        }

        renderGame();
        startTurn('PLAYER');
    }

    // --- PLAYER ACTION HANDLER ---
    window.cardAction = function(loc, uid) {
        if(turn !== 'PLAYER') return;
        
        // 1. SWAP MODE
        if(loc==='P_FLIGHT' && gameState==='SWAP_TARGET') {
            const flightIdx = pFlight.findIndex(c => c.uid === uid);
            const handCard = pHand[swapSourceIdx];
            pHand.splice(swapSourceIdx, 1); 
            let oldCard = pFlight.splice(flightIdx, 1, handCard)[0];
            log(`Upgraded! Swapped ${oldCard.r} for ${handCard.r}.`);
            gameState='IDLE'; nextTurn(); return;
        }

        // 2. STEAL & SWAP MODE
        if(loc==='P_FLIGHT' && gameState==='STEAL_SWAP') {
            const flightIdx = pFlight.findIndex(c => c.uid === uid);
            let discarded = pFlight.splice(flightIdx, 1, tempStolenCard)[0];
            log(`Stole ${tempStolenCard.r}, discarded own ${discarded.r}.`);
            tempStolenCard = null; gameState='IDLE'; nextTurn(); return;
        }

        // 3. HAND INTERACTION
        if(loc==='HAND' && gameState==='PLAY') {
            const idx = pHand.findIndex(c => c.uid === uid);
            const card = pHand[idx];
            if(document.getElementById('waste-mode').checked) {
                pHand.splice(idx,1); log(`Wasted ${card.r}${card.s}`); nextTurn(); return;
            }
            if(card.isBrew) {
                if(pFlight.length < 4) { 
                    pHand.splice(idx,1); pFlight.push(card); 
                    log(`Poured ${card.r}${card.s}`); nextTurn(); 
                } else {
                    swapSourceIdx = idx; gameState = 'SWAP_TARGET';
                    log("PADDLE FULL. Select a beer to REPLACE."); renderGame(); return;
                }
            } else {
                if(card.r==='A' && cFlight.length===0) { alert("Nothing to steal."); return; }
                if(card.r==='Q' && cFlight.length===0) { alert("Nothing to remove."); return; }
                handlePatron(card, idx);
            }
        }
        else if(loc==='HAND' && gameState==='DISCARD') {
            pHand.splice(pHand.findIndex(c=>c.uid===uid),1); log("Discarded."); nextTurn();
        }
        else if(loc==='CPU' && gameState==='TARGET') {
            if(pendingAction) pendingAction(cFlight.findIndex(c=>c.uid===uid));
        }
    }

    function handlePatron(c, i) {
        if(c.r==='J') { 
            pHand.splice(i,1); if(deck.length) pHand.push(deck.pop()); if(deck.length) pHand.push(deck.pop());
            log("Jack: Draw 2, Disc 1."); gameState='DISCARD'; renderGame();
        }
        else if(c.r==='K') {
            pHand.splice(i,1); 
            let discardedCount = 0;
            while(discardedCount < 2 && cHand.length > 0) {
                cHand.splice(Math.floor(Math.random() * cHand.length), 1);
                discardedCount++;
            }
            log(`King: House discards ${discardedCount} card(s).`); 
            nextTurn();
        }
        else if(c.r==='Q') {
            pHand.splice(i,1); log("Select beer to Remove."); gameState='TARGET';
            pendingAction=(t)=>{ cFlight.splice(t,1); log("Removed beer."); nextTurn(); }; renderGame();
        }
        else if(c.r==='A') {
            pHand.splice(i,1); log("Select beer to Steal."); gameState='TARGET';
            pendingAction=(t)=>{ 
                let stolen = cFlight.splice(t,1)[0];
                if(pFlight.length < 4) { pFlight.push(stolen); log("Stole beer."); nextTurn(); } 
                else { tempStolenCard = stolen; gameState = 'STEAL_SWAP'; log(`Paddle Full! Discard one of YOURS for ${stolen.r}.`); renderGame(); }
            }; renderGame();
        }
    }

    function nextTurn() { gameState='IDLE'; document.getElementById('last-call-btn').style.display='none'; renderGame(); startTurn('CPU'); }

    // --- RENDER ---
    function renderGame() {
        const rCard = (c, i) => {
            const isSelected = (gameState==='SWAP_TARGET' && i===swapSourceIdx);
            return `<div class="card ${['‚ô•','‚ô¶'].includes(c.s)?'red':'black'} ${isSelected?'selected':''}" 
                    onclick="cardAction('HAND','${c.uid}')">
                    <div class="card-corner">${c.r}<br>${c.s}</div>
                    <div class="card-corner bottom">${c.r}<br>${c.s}</div>
                    </div>`;
        };
        const rBeer = (c, loc) => {
            const clk = (loc==='CPU' && gameState==='TARGET') || (loc==='P_FLIGHT' && (gameState==='SWAP_TARGET' || gameState==='STEAL_SWAP'));
            const beerColor = getBeerColor(c.r);
            const isDark = parseInt(c.r) >= 8;
            const isRed = ['‚ô•','‚ô¶'].includes(c.s);
            return `<div class="beer-glass" 
                    style="--beer-color:${beerColor}; color:${isDark?'white':'black'}; text-shadow:${isDark?'0 0 2px black':'0 0 2px white'}; ${clk?'border-color:cyan; box-shadow:0 0 10px cyan':''}"
                    onclick="cardAction('${loc}','${c.uid}')">
                    ${c.r}
                    <div class="beer-label ${isRed?'suit-red':'suit-black'}">${c.s}</div>
                    </div>`;
        };

        document.getElementById('player-flight').innerHTML = pFlight.map(c=>rBeer(c,'P_FLIGHT')).join('');
        document.getElementById('cpu-flight').innerHTML = cFlight.map(c=>rBeer(c,'CPU')).join('');
        document.getElementById('player-hand').innerHTML = pHand.map((c,i)=>rCard(c,i)).join('');
        document.getElementById('cpu-hand-count').innerText = cHand.length;
        document.getElementById('current-score').innerText = calcScore(pFlight);
        document.getElementById('cpu-current-score').innerText = calcScore(cFlight);
    }

    // --- SCORING ---
    function calcScore(f) {
        if(!f.length) return 0;
        let s=f.reduce((a,b)=>a+b.val,0);
        if(f.length===4) {
            if(new Set(f.map(c=>c.s)).size===1) s+=20;
            else { let r=f.filter(c=>['‚ô•','‚ô¶'].includes(c.s)).length; if(r===0||r===4) s+=10; }
        }
        return s;
    }

    function endShift() {
        let ps=calcScore(pFlight), cs=calcScore(cFlight);
        let msg = `SHIFT OVER\n\nYou: ${ps} | House: ${cs}\n`;
        if(ps>cs) { msg+="üèÜ YOU WIN!"; matchPWins++; }
        else if(cs>ps) { msg+="üíÄ HOUSE WINS."; matchCWins++; }
        else msg+="ü§ù TIE.";
        updateMatchUI();
        setTimeout(() => {
            alert(msg);
            if(matchPWins>=3) { if(confirm("YOU WON THE MATCH! Play again?")) startNewMatch(); else goHome(); }
            else if(matchCWins>=3) { if(confirm("HOUSE WON THE MATCH. Retry?")) startNewMatch(); else goHome(); }
            else startShift(ps>cs?'PLAYER':(cs>ps?'CPU':(Math.random()>.5?'PLAYER':'CPU')));
        }, 100);
    }
</script>
</body>
</html>
