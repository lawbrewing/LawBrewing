<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Law Brewing Defender: The Sheriff of Taps</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rye&family=Roboto+Slab:wght@400;700&display=swap');

        body {
            background-color: #1a1a1a;
            color: white;
            font-family: 'Roboto Slab', serif;
            overflow: hidden;
            touch-action: none; 
            user-select: none;
            margin: 0;
            padding: 0;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, #2a2a2a 0%, #000000 100%);
            overflow: hidden;
        }

        /* --- Background Logo --- */
        #bg-logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80vmin;
            height: 80vmin;
            opacity: 0.3;
            pointer-events: none;
            z-index: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #bg-logo svg {
            width: 100%;
            height: 100%;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            display: block;
        }

        /* --- UI Overlays --- */
        .ui-overlay {
            position: absolute;
            z-index: 20;
            pointer-events: none;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
            transition: opacity 0.5s;
        }

        .hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.5rem;
            text-shadow: 2px 2px 0 #000;
            z-index: 20;
            pointer-events: none;
        }

        .btn {
            background: #fff;
            color: #000;
            border: 4px solid #fff;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-family: 'Rye', serif;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: transform 0.1s, background 0.2s;
            pointer-events: auto;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .btn:hover {
            transform: scale(1.05);
            background: #eee;
        }

        .btn:active {
            transform: scale(0.95);
        }

        h1 {
            font-family: 'Rye', serif;
            font-size: 4rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 4px 10px rgba(0,0,0,0.8);
            color: #fff;
            line-height: 1;
        }
        
        h2 {
            font-family: 'Rye', serif;
            font-size: 2rem;
            margin-bottom: 2rem;
            color: #ccc;
        }

        .hidden {
            display: none !important;
        }
        
        .tutorial {
            background: rgba(0,0,0,0.6);
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #555;
            max-width: 90%;
            width: 550px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        .icon-row {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .icon-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
            text-align: center;
        }
        
        .icon-desc {
            font-size: 0.8rem;
            margin-top: 8px;
            color: #aaa;
            line-height: 1.2;
        }
        
        /* Level Transition Text Style */
        #level-transition {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Rye', serif;
            font-size: 5rem;
            color: gold;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.8), 0 0 20px black;
            z-index: 30;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            text-align: center;
            width: 100%;
        }

        #level-subtext {
            display: block;
            font-size: 2rem;
            color: white;
            font-family: 'Roboto Slab', serif;
            margin-top: 10px;
        }

        .show-transition {
            opacity: 1 !important;
        }
        
        /* Title Page Specifics */
        .title-img {
            max-width: 80%;
            max-height: 50vh;
            border: 5px solid #fff;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            margin-bottom: 30px;
            border-radius: 4px;
        }

        /* --- Leaderboard Styles --- */
        .leaderboard-container {
            width: 90%;
            max-width: 600px;
            background: rgba(40, 40, 40, 0.95);
            border: 5px solid gold;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 20px 0 0;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #555;
            font-size: 1.2rem;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-rank {
            font-family: 'Rye', serif;
            color: gold;
            width: 30px;
            text-align: left;
        }

        .leaderboard-score {
            font-weight: bold;
            color: #fff;
            text-align: right;
        }

        /* --- Share Card Design (Hidden Off-Screen) --- */
        #share-card {
            width: 400px; /* Fixed size for a good share image */
            height: 400px;
            background: radial-gradient(circle at center, #2a2a2a 0%, #000000 100%);
            border: 10px solid gold;
            border-radius: 10px;
            position: absolute;
            top: -9999px; /* Hide it off-screen, but keep it in the DOM for capture */
            left: -9999px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-family: 'Roboto Slab', serif;
            color: white;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            z-index: 999;
        }

        #share-card-title {
            font-family: 'Rye', serif;
            font-size: 2.5rem;
            color: gold;
            margin-bottom: 5px;
            text-shadow: 0 0 5px black;
        }

        #share-card-score {
            font-size: 4rem;
            font-weight: bold;
            color: white;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #ffeb3b;
        }

        #share-card-logo {
            width: 150px;
            height: 150px;
            opacity: 0.8;
            margin-top: 10px;
        }

    </style>
</head>
<body>

<div id="game-container">
    <div id="bg-logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 600" preserveAspectRatio="xMidYMid meet">
            <defs>
                <linearGradient id="metal" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#d9d9d9"/>
                    <stop offset="100%" stop-color="#7a7a7a"/>
                </linearGradient>
                <linearGradient id="gold" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" stop-color="#ffeb8a"/>
                    <stop offset="100%" stop-color="#c59a00"/>
                </linearGradient>
            </defs>
            <circle cx="300" cy="300" r="260" fill="url(#metal)" stroke="#000" stroke-width="6"/>
            <polygon points="300,70 355,240 535,240 390,345 445,515 300,410 155,515 210,345 65,240 245,240" fill="url(#metal)" stroke="#000" stroke-width="5"/>
            <text x="300" y="285" font-family="Rye, serif" font-size="150" text-anchor="middle" fill="url(#gold)" stroke="#000" stroke-width="4">LAW</text>
            <text x="300" y="380" font-family="Rye, serif" font-size="70" text-anchor="middle" fill="url(#gold)" stroke="#000" stroke-width="3">BREWING</text>
        </svg>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="hud" class="hud hidden">
        <div>LEVEL: <span id="level">1</span></div>
        <div>SCORE: <span id="score">0</span></div>
        <div>LIVES: <span id="lives">3</span></div>
        <button id="show-leaderboard-btn" class="btn" style="padding: 5px 15px; font-size: 1rem; pointer-events: auto; margin-top: 0;">Board</button>
    </div>
    
    <div id="level-transition">
        <span id="level-title">LEVEL 1</span>
        <span id="level-subtext"></span>
    </div>

    <div id="landing-page" class="ui-overlay">
        <img src="https://github.com/lawbrewing/LawBrewing/blob/main/Gemini_Generated_Image_f46i9af46i9af46i.png?raw=true" 
            alt="Law Brewing Co." 
            class="title-img">
        
        <button id="enter-btn" class="btn">ENTER TAPROOM</button>
    </div>

    <div id="start-screen" class="ui-overlay hidden">
        <h1>LAW<br>BREWING</h1>
        <h2>Quality Control</h2>
        
        <div class="tutorial">
            <p style="margin-bottom: 15px; color: #fff; font-size: 1.1rem;">You are the Sheriff of Taps. Defend the quality of the brew!</p>
            
            <div class="icon-row">
                <div class="icon-box">
                    <svg width="40" height="60" viewBox="0 0 50 80">
                        <rect x="10" y="10" width="30" height="60" rx="2" fill="#9ca3af" stroke="#4b5563" stroke-width="2"/>
                        <rect x="10" y="20" width="30" height="40" fill="#ef4444" opacity="0.8"/>
                        <text x="25" y="45" text-anchor="middle" font-family="sans-serif" font-size="10" fill="white">SWILL</text>
                    </svg>
                    <span class="icon-desc">SHOOT THIS<br><strong style="color: #ef4444">(Bad Beer)</strong><br>Must NOT reach the bar!</span>
                </div>
                <div class="icon-box">
                    <svg width="40" height="60" viewBox="0 0 50 80">
                        <path d="M10 10 L15 70 L35 70 L40 10 Z" fill="#d97706" stroke="#fff" stroke-width="2" opacity="0.8"/>
                        <path d="M10 10 Q25 0 40 10 L40 20 L10 20 Z" fill="#fff"/>
                    </svg>
                    <span class="icon-desc">SAVE THIS<br><strong style="color: #d97706">(Law Brew)</strong><br>Must reach the VIP & bar!</span>
                </div>
            </div>

            <div style="margin-top: 15px; border-top: 1px dashed #555; padding-top: 15px;">
                <p style="color: #ffeb3b; font-size: 0.9rem; font-weight: bold; margin-bottom: 10px;">STRATEGY & THREATS</p>
                
                <div class="icon-row">
                    <div class="icon-box">
                        <svg width="40" height="40" viewBox="0 0 50 50">
                            <rect x="15" y="5" width="20" height="5" fill="#b45309"/>
                            <path d="M15 10 A10 5 0 0 1 35 10" fill="#b45309"/>
                            <circle cx="25" cy="15" r="7" fill="#fdbd9c"/>
                            <rect x="10" y="22" width="30" height="20" fill="#4b5563"/>
                        </svg>
                        <span class="icon-desc"><strong>The Old Timer</strong><br>Don't let him spend his last $1 on swill!</span>
                    </div>

                    <div class="icon-box">
                        <svg width="50" height="50" viewBox="0 0 60 60">
                            <rect x="5" y="40" width="50" height="15" fill="#5D4037" stroke="#3E2723" />
                            <circle cx="30" cy="20" r="10" fill="#FFE0B2" />
                            <path d="M20 20 Q30 5 40 20 Q42 35 30 38 Q18 35 20 20" fill="#212121" />
                            <path d="M20 30 Q30 45 40 30" fill="#9C27B0" />
                        </svg>
                        <span class="icon-desc"><strong>The VIP</strong> (Lvl 3+)<br>Move the table to catch Law Brew for a bonus!</span>
                    </div>
                </div>
                <p style="font-size: 1.1rem; color: #fff;">
                    Tap/Drag the <strong style="color: #ffeb3b;">bottom half</strong> of the screen to move the VIP's table.
                </p>
            </div>
        </div>

        <button id="start-btn" class="btn">Start Shift</button>
    </div>

    <div id="game-over-screen" class="ui-overlay hidden">
        <h1>SHIFT OVER</h1>
        <h2>Final Score: <span id="final-score">0</span></h2>
        <p id="high-score-msg" style="margin-bottom: 15px; font-size: 1.5rem; color: #ffeb3b; font-family: 'Rye', serif; display: none;">New High Score!</p>
        <p id="game-over-msg" style="margin-bottom: 20px; font-size: 1.5rem; color: #aaa;">Last Call.</p>
        
        <button id="share-score-btn" class="btn hidden" style="background: gold; color: black; border-color: gold;">Share Score ðŸ“¸</button>
        <button id="restart-btn" class="btn">Re-Open Tab</button>
        <button id="show-leaderboard-final-btn" class="btn" style="background: #333; border-color: #555;">View Leaderboard</button>
    </div>

    <div id="leaderboard-screen" class="ui-overlay hidden">
        <h1>TAPROOM HALL OF FAME</h1>
        <div class="leaderboard-container">
            <h2 style="margin-bottom: 10px;">Top 5 Sheriffs</h2>
            <ul id="leaderboard-list" class="leaderboard-list">
                </ul>
        </div>
        <button id="close-leaderboard-btn" class="btn">Back to Game</button>
    </div>

    <div id="share-card">
        <h2 id="share-card-title">LAW BREWING DEFENDER</h2>
        <p style="font-size: 1.5rem; margin-top: 5px;">NEW HIGH SCORE!</p>
        <div id="share-card-score">0</div>
        <div id="share-card-logo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 600" preserveAspectRatio="xMidYMid meet">
                <defs>
                    <linearGradient id="metal" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#d9d9d9"/>
                        <stop offset="100%" stop-color="#7a7a7a"/>
                    </linearGradient>
                    <linearGradient id="gold" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stop-color="#ffeb8a"/>
                        <stop offset="100%" stop-color="#c59a00"/>
                    </linearGradient>
                </defs>
                <circle cx="300" cy="300" r="260" fill="url(#metal)" stroke="#000" stroke-width="6"/>
                <polygon points="300,70 355,240 535,240 390,345 445,515 300,410 155,515 210,345 65,240 245,240" fill="url(#metal)" stroke="#000" stroke-width="5"/>
                <text x="300" y="285" font-family="Rye, serif" font-size="150" text-anchor="middle" fill="url(#gold)" stroke="#000" stroke-width="4">LAW</text>
                <text x="300" y="380" font-family="Rye, serif" font-size="70" text-anchor="middle" fill="url(#gold)" stroke="#000" stroke-width="3">BREWING</text>
            </svg>
        </div>
        <p style="font-size: 1rem; margin-top: 15px; color: #ccc;">Can you beat the Sheriff of Taps?</p>
    </div>
</div>

<script>
    /* --- Game Setup --- */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // UI Elements
    const landingPage = document.getElementById('landing-page');
    const enterBtn = document.getElementById('enter-btn');
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const hud = document.getElementById('hud');
    
    const scoreEl = document.getElementById('score');
    const livesEl = document.getElementById('lives');
    const levelEl = document.getElementById('level'); 
    const finalScoreEl = document.getElementById('final-score');
    
    const startBtn = document.getElementById('start-btn');
    const restartBtn = document.getElementById('restart-btn');
    
    const levelTransitionEl = document.getElementById('level-transition'); 
    const levelTitleEl = document.getElementById('level-title');
    const levelSubtextEl = document.getElementById('level-subtext');

    // NEW UI ELEMENTS FOR LEADERBOARD/SHARE
    const leaderboardScreen = document.getElementById('leaderboard-screen');
    const leaderboardList = document.getElementById('leaderboard-list');
    const showLeaderboardBtn = document.getElementById('show-leaderboard-btn');
    const showLeaderboardFinalBtn = document.getElementById('show-leaderboard-final-btn');
    const closeLeaderboardBtn = document.getElementById('close-leaderboard-btn');
    const highScoreMsg = document.getElementById('high-score-msg');
    const shareScoreBtn = document.getElementById('share-score-btn');
    const shareCard = document.getElementById('share-card');
    const shareCardScore = document.getElementById('share-card-score');


    /* --- Level Configuration --- */
    const levelsConfig = [
        { scoreToClear: 1000, spawnIntervalMs: 1500, speedMultiplier: 1.0, thiefSpawnMs: 999999, vipActive: false }, 
        { scoreToClear: 2500, spawnIntervalMs: 1200, speedMultiplier: 1.3, thiefSpawnMs: 7000, vipActive: false }, 
        { scoreToClear: 4500, spawnIntervalMs: 1000, speedMultiplier: 1.6, thiefSpawnMs: 6000, vipActive: true }, // VIP ACTIVE HERE
        { scoreToClear: 7000, spawnIntervalMs: 800, speedMultiplier: 2.0, thiefSpawnMs: 5000, vipActive: true }, 
        { scoreToClear: 11000, spawnIntervalMs: 700, speedMultiplier: 2.3, thiefSpawnMs: 4000, vipActive: true } 
    ];

    // Game State
    let isPlaying = false;
    let score = 0;
    let lives = 3;
    let currentLevel = 1;
    let lastTime = 0;
    
    // Player/VIP State
    let playerGuestX; // Player-controlled X position for the VIP table
    let vipInstance;  // The single VIP object
    let isMovingGuest = false; // Flag for drag/touch input on the VIP table area

    // Spawning/Difficulty variables
    let spawnTimer = 0;
    let spawnInterval = levelsConfig[0].spawnIntervalMs; 
    let speedMultiplier = levelsConfig[0].speedMultiplier;
    
    let thiefSpawnTimer = 0;
    let thiefSpawnInterval = levelsConfig[0].thiefSpawnMs; 

    let isTransitioning = false;
    
    // Arrays for entities
    let beers = [];
    let particles = [];
    let clickEffects = [];
    let thieves = []; 

    /* --- Resize Handling --- */
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        // Reset VIP position on resize
        playerGuestX = canvas.width / 2;
        if (vipInstance) {
            vipInstance.y = canvas.height - 100; // Keep it fixed at the bottom
        }
    }
    window.addEventListener('resize', resize);
    resize();

    /* --- Input Handling for Shooting --- */
    const handleShootInput = (x, y) => {
        if (!isPlaying || isTransitioning) return;

        // If the tap/click is in the VIP control zone (bottom 1/3), don't shoot!
        if (y > canvas.height * 0.7) { 
            return;
        }

        clickEffects.push({x, y, age: 0});

        // 1. Thieves
        for (let i = thieves.length - 1; i >= 0; i--) {
            const t = thieves[i];
            const dist = Math.hypot(t.x - x, t.y - y);
            
            if (dist < t.size / 2) { 
                t.isHit = true;
                lives--;
                livesEl.innerText = lives;
                createFloatingText(t.x, t.y, "DEAD TIMER", "red");
                createExplosion(t.x, t.y, '#fdbd9c');
                checkGameOver();
                return;
            }
        }

        // 2. Beers
        for (let i = beers.length - 1; i >= 0; i--) {
            const b = beers[i];
            const dist = Math.hypot(b.x - x, b.y - y);
            
            if (dist < 40) {
                if (b.type === 'BAD') {
                    // CORRECT ACTION: Shoot the Swill
                    createExplosion(b.x, b.y, '#9ca3af');
                    beers.splice(i, 1);
                    score += 100;
                    scoreEl.innerText = score.toLocaleString();
                    createFloatingText(b.x, b.y, "+100", "white");
                    checkLevelUp();
                } else {
                    // INCORRECT ACTION: Shot the Law Brew
                    createExplosion(b.x, b.y, '#d97706');
                    beers.splice(i, 1);
                    lives--;
                    livesEl.innerText = lives;
                    createFloatingText(b.x, b.y, "WASTED BREW!", "red");
                    checkGameOver();
                }
                return; 
            }
        }
    };

    /* --- Input Handlers for VIP Movement --- */

    const handleGuestMoveStart = (x, y) => {
        // Only start moving if input is in the bottom 1/3 of the screen
        if (y > canvas.height * 0.7) {
            isMovingGuest = true;
        }
    };

    const handleGuestMove = (x) => {
        if (isMovingGuest && isPlaying && !isTransitioning) {
            // Clamp the VIP position within the canvas boundaries (with padding)
            const minX = 60; // Table width approx. 70, so half padding
            const maxX = canvas.width - 60;
            playerGuestX = Math.min(Math.max(x, minX), maxX);
        }
    };

    const handleGuestMoveEnd = () => {
        isMovingGuest = false;
    };

    // MOUSE EVENTS
    canvas.addEventListener('mousedown', (e) => {
        if (e.clientY > canvas.height * 0.7) {
             handleGuestMoveStart(e.clientX, e.clientY);
        } else {
            handleShootInput(e.clientX, e.clientY);
        }
    });

    canvas.addEventListener('mousemove', (e) => {
        handleGuestMove(e.clientX);
    });

    canvas.addEventListener('mouseup', handleGuestMoveEnd);
    canvas.addEventListener('mouseleave', handleGuestMoveEnd);

    // TOUCH EVENTS
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const x = e.touches[0].clientX;
        const y = e.touches[0].clientY;
        
        if (y > canvas.height * 0.7) {
            handleGuestMoveStart(x, y); 
        } else {
            handleShootInput(x, y);
        }
    }, {passive: false});

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        handleGuestMove(e.touches[0].clientX);
    }, {passive: false});

    canvas.addEventListener('touchend', handleGuestMoveEnd);

    /* --- Classes --- */

    class Beer {
        constructor() {
            this.radius = 30;
            this.x = Math.random() * (canvas.width - 60) + 30;
            this.y = -50;
            this.type = Math.random() > 0.35 ? 'BAD' : 'GOOD'; 
            const baseSpeed = canvas.height / 500; 
            this.speed = (baseSpeed * speedMultiplier) * (1 + Math.random() * 0.4); 
            this.rotation = 0;
            this.rotSpeed = (Math.random() - 0.5) * 0.1;
        }

        update(dt) {
            this.y += this.speed;
            this.rotation += this.rotSpeed;
        }

        draw(ctx) {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);

            if (this.type === 'BAD') {
                // Swill (Bad Beer) Drawing
                ctx.fillStyle = '#9ca3af'; 
                ctx.fillRect(-15, -25, 30, 50);
                ctx.fillStyle = '#d1d5db';
                ctx.fillRect(-15, -25, 30, 5);
                ctx.fillRect(-15, 20, 30, 5);
                ctx.fillStyle = '#ef4444';
                ctx.fillRect(-15, -10, 30, 20);
                ctx.fillStyle = 'white';
                ctx.font = 'bold 10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText("SWILL", 0, 5);
            } else {
                // Law Brew (Good Beer) Drawing 
                ctx.beginPath();
                ctx.moveTo(-15, -25);
                ctx.lineTo(-10, 25);
                ctx.lineTo(10, 25);
                ctx.lineTo(15, -25);
                ctx.closePath();
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#fff';
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(-13, -15);
                ctx.lineTo(-9, 23);
                ctx.lineTo(9, 23);
                ctx.lineTo(13, -15);
                ctx.closePath();
                ctx.fillStyle = '#d97706'; 
                ctx.fill();

                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.ellipse(0, -15, 13, 5, 0, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(0, 0, 5, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.restore();
        }
    }

    class PatronRaider { 
        constructor() {
            this.size = 50;
            this.y = Math.random() * (canvas.height * 0.3) + 100;
            if (Math.random() < 0.5) {
                this.x = -this.size;
                this.vx = 0.5 + Math.random() * 0.5 * speedMultiplier;
                this.side = 'left';
            } else {
                this.x = canvas.width + this.size;
                this.vx = -(0.5 + Math.random() * 0.5 * speedMultiplier);
                this.side = 'right';
            }
            this.vy = 0.1 + Math.random() * 0.1 * speedMultiplier; 
            this.isHit = false;
            this.life = 100;
        }

        update() {
            this.x += this.vx;
            this.y += this.vy;
            if (this.isHit) this.life -= 3;
        }

        draw(ctx) {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.globalAlpha = this.life / 100;
            let scaleX = 1;
            if (this.side === 'right') scaleX = -1;
            ctx.scale(scaleX, 1);

            // Old Timer Hat
            ctx.fillStyle = '#f0f0f0';
            ctx.beginPath();
            ctx.ellipse(0, -25, 20, 10, 0, Math.PI, 0, true);
            ctx.fill();
            ctx.fillRect(-15, -25, 30, 5);

            // Head (Skin tone)
            ctx.fillStyle = '#fdbd9c';
            ctx.beginPath();
            ctx.arc(0, -15, 10, 0, Math.PI * 2);
            ctx.fill();
            
            // Body (Blue shirt)
            ctx.fillStyle = '#4b5563';
            ctx.fillRect(-15, -10, 30, 30);
            
            // Arm/Sleeve (right arm from his perspective)
            ctx.fillStyle = '#4b5563'; 
            ctx.fillRect(10, 0, 10, 20); // Arm

            // Hand (skin tone)
            ctx.fillStyle = '#fdbd9c';
            ctx.beginPath();
            ctx.arc(15, 20, 5, 0, Math.PI * 2);
            ctx.fill();

            // Dollar Bill
            ctx.fillStyle = '#8bc34a';
            ctx.strokeStyle = '#4c8c2a';
            ctx.lineWidth = 1;
            ctx.fillRect(18, 15, 20, 10);
            ctx.strokeRect(18, 15, 20, 10);
            ctx.fillStyle = '#4c8c2a';
            ctx.font = '6px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('$1', 28, 22);

            ctx.globalAlpha = 1.0;
            ctx.restore();
        }
    }

    class TableGuest { 
        constructor(initialY) {
            this.x = playerGuestX; 
            this.y = initialY; 
            this.isVipActive = false; 
            this.tableWidth = 70;
            this.tableHeight = 20;
            this.chairHeight = 35;
            this.bodyWidth = 30;
            this.bodyHeight = 30;
        }

        update() {
             this.x = playerGuestX;
        }

        draw(ctx) {
            ctx.save();
            ctx.translate(this.x, this.y);
            const tableTopY = 0;

            // --- Draw Table ---
            ctx.fillStyle = '#5D4037'; 
            ctx.fillRect(-this.tableWidth/2, tableTopY, this.tableWidth, this.tableHeight);
            ctx.strokeStyle = '#3E2723';
            ctx.lineWidth = 2;
            ctx.strokeRect(-this.tableWidth/2, tableTopY, this.tableWidth, this.tableHeight);

            // Legs
            ctx.fillRect(-this.tableWidth/2 + 5, this.tableHeight, 5, 20);
            ctx.fillRect(this.tableWidth/2 - 10, this.tableHeight, 5, 20);

           // --- Draw VIP Guest (only if active) ---
            if (this.isVipActive) {
                const guestOffsetY = tableTopY - 10;
                
                // 1. Purple Dress/Body (Flat Vector Style)
                ctx.fillStyle = '#9C27B0'; // Purple
                ctx.beginPath();
                ctx.ellipse(0, guestOffsetY + 10, 20, 15, 0, Math.PI, 0, true);
                ctx.fill();

                // 2. Head (Skin tone)
                ctx.fillStyle = '#FFE0B2'; // Skin tone
                ctx.beginPath();
                ctx.arc(0, guestOffsetY - 10, 10, 0, Math.PI * 2);
                ctx.fill();

                // 3. Dark Hair (Flat bob or simple style)
                ctx.fillStyle = '#212121'; // Black/dark hair
                ctx.beginPath();
                ctx.ellipse(0, guestOffsetY - 10, 12, 12, 0, 0, Math.PI, false); // Top curve
                ctx.lineTo(12, guestOffsetY + 2); 
                ctx.lineTo(-12, guestOffsetY + 2);
                ctx.closePath();
                ctx.fill();

                // --- Objects on Table: Empty Beer Glass (Left Side) ---
                const glassX = -this.tableWidth/2 + 15;
                const glassY = tableTopY + 5;
                
                // Glass Rim
                ctx.fillStyle = '#fefefe';
                ctx.fillRect(glassX - 5, glassY, 10, 2);
                
                // Glass Body (Transparent)
                ctx.fillStyle = 'rgba(200, 200, 255, 0.3)';
                ctx.fillRect(glassX - 5, glassY + 2, 10, 15);
                
                // Glass Base
                ctx.fillStyle = '#4b5563';
                ctx.fillRect(glassX - 6, glassY + 17, 12, 3);
            }

            ctx.restore();
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 5 + 2;
            this.vx = Math.cos(angle) * speed;
            this.vy = Math.sin(angle) * speed;
            this.life = 1.0;
            this.decay = Math.random() * 0.03 + 0.02;
            this.size = Math.random() * 4 + 2;
        }
        update() {
            this.x += this.vx; this.y += this.vy; this.vy += 0.2;
            this.life -= this.decay;
        }
        draw(ctx) {
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
            ctx.fill();
            ctx.globalAlpha = 1.0;
        }
    }

    class FloatingText {
        constructor(x, y, text, color) {
            this.x = x; this.y = y; this.text = text; this.color = color;
            this.life = 1.0; this.vy = -2;
        }
        update() { this.y += this.vy; this.life -= 0.02; }
        draw(ctx) {
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillStyle = this.color;
            ctx.font = "bold 20px 'Roboto Slab'";
            ctx.textAlign = 'center';
            ctx.fillText(this.text, this.x, this.y);
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;
            ctx.strokeText(this.text, this.x, this.y);
            ctx.globalAlpha = 1.0;
        }
    }

    /* --- Helper Functions --- */

    function createExplosion(x, y, color) {
        for(let i=0; i<15; i++) particles.push(new Particle(x, y, color));
    }

    function createFloatingText(x, y, text, color) {
        particles.push(new FloatingText(x, y, text, color));
    }

    function checkGameOver() {
        if (lives <= 0) endGame();
    }

    function checkLevelUp() {
        if (currentLevel <= levelsConfig.length) {
            const currentLevelIndex = currentLevel - 1;
            const requiredScore = levelsConfig[currentLevelIndex].scoreToClear;

            if (score >= requiredScore) {
                currentLevel++;
                transitionToLevel(currentLevel);
            }
        }
    }

    function transitionToLevel(newLevel) {
        isTransitioning = true;
        beers = []; thieves = []; 
        spawnTimer = 0; thiefSpawnTimer = 0; 

        let titleText, subText;
        
        if (newLevel <= levelsConfig.length) {
            const cfg = levelsConfig[newLevel - 1];
            titleText = `LEVEL ${newLevel}`;
            
            // --- VIP Activation Logic ---
            if (cfg.vipActive) {
                subText = "VIP IS NOW ACTIVE! CATCH LAW BREWS!";
                vipInstance.isVipActive = true;
            } else if (newLevel === 2) {
                subText = "HERE COMES THE OLD TIMER!";
                vipInstance.isVipActive = false;
            } else {
                subText = "FASTER!";
                vipInstance.isVipActive = false;
            }

            // Config Logic
            spawnInterval = cfg.spawnIntervalMs;
            speedMultiplier = cfg.speedMultiplier;
            thiefSpawnInterval = cfg.thiefSpawnMs;
            levelEl.textContent = newLevel;
        } else {
            // Expert Mode
            titleText = `EXPERT MODE`;
            subText = "SURVIVE";
            spawnInterval = 500;
            speedMultiplier = 3.0;
            thiefSpawnInterval = 3000;
            vipInstance.isVipActive = true; 
            levelEl.textContent = 'E';
        }
        
        levelTitleEl.textContent = titleText;
        levelSubtextEl.textContent = subText;
        levelTransitionEl.classList.add('show-transition');

        setTimeout(() => {
            levelTransitionEl.classList.remove('show-transition');
            isTransitioning = false;
        }, 2500);
    }

    /* --- Leaderboard & High Score Logic --- */
    const LEADERBOARD_KEY = 'lawbrewing_highscores';

    /**
     * Loads high scores from local storage.
     * @returns {Array<number>} Sorted array of scores.
     */
    function loadHighScores() {
        const scores = localStorage.getItem(LEADERBOARD_KEY);
        try {
            return scores ? JSON.parse(scores).sort((a, b) => b - a) : [];
        } catch (e) {
            console.error("Error loading scores from localStorage:", e);
            return [];
        }
    }

    /**
     * Saves a new score and checks if it's a new high score.
     * @param {number} newScore - The score to save.
     * @returns {boolean} True if a new high score was set.
     */
    function saveNewScore(newScore) {
        let scores = loadHighScores();
        const isNewHighScore = (scores.length === 0 || newScore > scores[0]);

        // Add the new score, sort, and keep only the top 5
        scores.push(newScore);
        scores.sort((a, b) => b - a);
        scores = scores.slice(0, 5);

        localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(scores));
        return isNewHighScore;
    }

    /**
     * Renders the leaderboard HTML list.
     */
    function renderLeaderboard() {
        const scores = loadHighScores();
        leaderboardList.innerHTML = '';

        if (scores.length === 0) {
            leaderboardList.innerHTML = '<li class="text-center text-gray-400 py-4">No scores yet! Play a game.</li>';
            return;
        }

        scores.forEach((s, index) => {
            const listItem = document.createElement('li');
            listItem.className = 'leaderboard-item';
            
            if (index === 0) {
                listItem.classList.add('text-yellow-300');
            }
            
            listItem.innerHTML = `
                <span class="leaderboard-rank">${index + 1}.</span>
                <span class="leaderboard-score">${s.toLocaleString()}</span>
            `;
            leaderboardList.appendChild(listItem);
        });
    }

    /**
     * Generates an image of the share card using html2canvas and triggers the share dialog.
     */
    function generateAndShareImage() {
        // 1. Prepare the off-screen card
        shareCardScore.textContent = finalScoreEl.textContent;

        // 2. Capture the HTML element
        html2canvas(shareCard, {
            backgroundColor: null, 
            scale: 2 
        }).then(canvas => {
            canvas.toBlob((blob) => {
                if (!blob) {
                    alert("Could not create share image.");
                    return;
                }
                const file = new File([blob], 'LawBrewingHighscore.png', {type: 'image/png'});
                const data = {
                    files: [file],
                    title: 'Law Brewing Defender High Score!',
                    text: `I just scored ${finalScoreEl.textContent} in Law Brewing Defender: The Sheriff of Taps! Can you beat my score? #LawBrewing #Highscore`
                };

                // 3. Use the Web Share API if available
                if (navigator.canShare && navigator.canShare(data)) {
                    navigator.share(data).catch(error => {
                        console.error('Sharing failed:', error);
                        alert("Sharing failed or was cancelled.");
                    });
                } else {
                    // 4. Fallback for browsers that don't support the Web Share API: offer a download
                    const dataUrl = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = 'LawBrewingHighscore.png';
                    link.href = dataUrl;
                    link.click();
                    alert("Sharing is not supported on this browser. Your image has been downloaded!");
                }
            }, 'image/png');
        });
    }


    /* --- Menu Flow Functions (Updated) --- */
    function endGame() {
        isPlaying = false;
        hud.classList.add('hidden');
        gameOverScreen.classList.remove('hidden');
        finalScoreEl.innerText = score.toLocaleString();

        // NEW: Check and save the score
        const isNewHighScore = saveNewScore(score);

        // NEW: Update Game Over Screen based on result
        if (isNewHighScore) {
            highScoreMsg.style.display = 'block';
            shareScoreBtn.classList.remove('hidden');
        } else {
            highScoreMsg.style.display = 'none';
            shareScoreBtn.classList.add('hidden');
        }

        document.getElementById('game-over-msg').textContent = isNewHighScore 
            ? "A legendary shift! Share your victory!" 
            : "Last Call. Try for a better score!";
    }

    function startGame() {
        score = 0; lives = 3; currentLevel = 1;
        
        // Reset to Level 1 config
        spawnInterval = levelsConfig[0].spawnIntervalMs;
        speedMultiplier = levelsConfig[0].speedMultiplier;
        thiefSpawnInterval = levelsConfig[0].thiefSpawnMs;

        scoreEl.innerText = score.toLocaleString();
        livesEl.innerText = lives;
        levelEl.innerText = currentLevel;
        
        beers = []; particles = []; clickEffects = []; thieves = [];
        spawnTimer = 0; thiefSpawnTimer = 0;
        isTransitioning = false;

        // Initialize VIP instance
        if (!vipInstance) {
            vipInstance = new TableGuest(canvas.height - 100);
        }
        vipInstance.isVipActive = false;
        
        isPlaying = true;
        startScreen.classList.add('hidden');
        gameOverScreen.classList.add('hidden');
        hud.classList.remove('hidden');
        
        lastTime = performance.now();
        requestAnimationFrame(gameLoop);
    }

    /* --- Game Loop and Drawing Functions --- */

    function update(dt) {
        if (!isPlaying || isTransitioning) return;

        // --- Spawning Logic ---
        spawnTimer += dt;
        if (spawnTimer >= spawnInterval) {
            beers.push(new Beer());
            spawnTimer = 0;
        }

        thiefSpawnTimer += dt;
        if (thieves.length === 0 && thiefSpawnTimer >= thiefSpawnInterval && currentLevel >= 2) {
            thieves.push(new PatronRaider());
            thiefSpawnTimer = 0;
        }

        // --- Update Entities ---
        beers.forEach(b => b.update(dt));
        vipInstance.update();
        particles.forEach(p => p.update(dt));
        thieves.forEach(t => t.update(dt));

        // --- Collision and Cleanup ---

        // 1. Beer cleanup and score/life updates
        for (let i = beers.length - 1; i >= 0; i--) {
            const b = beers[i];

            // Check if beer reached the bottom (the bar)
            if (b.y > canvas.height + 50) {
                if (b.type === 'BAD') {
                    // Fail: Bad beer reached the bar
                    lives--;
                    livesEl.innerText = lives;
                    createFloatingText(b.x, canvas.height - 20, "-1 LIFE!", "red");
                    beers.splice(i, 1);
                    checkGameOver();
                    continue;
                } else {
                    // Success: Good beer reached the bar
                    score += 50;
                    scoreEl.innerText = score.toLocaleString();
                    createFloatingText(b.x, canvas.height - 20, "+50 (Bar)", "green");
                    beers.splice(i, 1);
                    checkLevelUp();
                    continue;
                }
            }

            // Check collision with VIP table (only if VIP is active)
            if (vipInstance.isVipActive && b.y > vipInstance.y - b.radius * 2) {
                const dx = b.x - vipInstance.x;
                // Check if the beer is horizontally over the table's width
                if (Math.abs(dx) < vipInstance.tableWidth / 2) {
                    if (b.type === 'GOOD') {
                        // VIP Success: Law Brew caught by VIP
                        score += 500;
                        scoreEl.innerText = score.toLocaleString();
                        createFloatingText(b.x, b.y, "+500 (VIP!)", "yellow");
                        createExplosion(b.x, b.y, '#ffeb3b');
                        beers.splice(i, 1);
                        checkLevelUp();
                        continue;
                    } 
                    // Bad beer is just passed to the bar/bottom line
                }
            }

            // Check collision with thieves (Old Timer)
            for (let j = thieves.length - 1; j >= 0; j--) {
                const t = thieves[j];
                const dist = Math.hypot(b.x - t.x, b.y - t.y);
                if (dist < t.size / 2 + b.radius * 0.5) {
                    if (b.type === 'BAD') {
                        // Fail: Old Timer got the Swill
                        lives--;
                        livesEl.innerText = lives;
                        createFloatingText(t.x, t.y, "DRANK SWILL!", "red");
                        createExplosion(t.x, t.y, 'red');
                        thieves.splice(j, 1);
                        beers.splice(i, 1);
                        checkGameOver();
                        break;
                    } else {
                        // Success: Old Timer got the good stuff (removes threat)
                        score += 250;
                        scoreEl.innerText = score.toLocaleString();
                        createFloatingText(t.x, t.y, "+250 (Fed Timer)", "gold");
                        createExplosion(t.x, t.y, 'gold');
                        thieves.splice(j, 1);
                        beers.splice(i, 1);
                        checkLevelUp();
                        break;
                    }
                }
            }
        }
        
        // 2. Thief cleanup (off-screen or hit)
        for (let i = thieves.length - 1; i >= 0; i--) {
            const t = thieves[i];
            if (t.life <= 0 || t.x < -t.size || t.x > canvas.width + t.size) {
                thieves.splice(i, 1);
            }
        }

        // 3. Particle cleanup
        particles = particles.filter(p => p.life > 0);
    }


    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw entities
        beers.forEach(b => b.draw(ctx));
        thieves.forEach(t => t.draw(ctx));
        vipInstance.draw(ctx); // Draw VIP table/guest last to appear in front of beers

        // Draw bar line / bottom boundary
        ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.fillRect(0, canvas.height - 5, canvas.width, 5);
        ctx.fillStyle = '#6d4c41'; // Wood/bar color
        ctx.fillRect(0, canvas.height, canvas.width, -30);

        // Draw effects
        particles.forEach(p => p.draw(ctx));
        
        // Draw click effects
        for (let i = clickEffects.length - 1; i >= 0; i--) {
            const c = clickEffects[i];
            ctx.strokeStyle = `rgba(255, 255, 255, ${1 - c.age / 10})`;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(c.x, c.y, c.age * 5, 0, Math.PI * 2);
            ctx.stroke();
            c.age++;
            if (c.age > 10) clickEffects.splice(i, 1);
        }
    }

    function gameLoop(currentTime) {
        if (!isPlaying) return;

        const deltaTime = (currentTime - lastTime) / 16.666; // Approx 60 FPS delta
        lastTime = currentTime;

        update(deltaTime);
        draw();

        requestAnimationFrame(gameLoop);
    }

    /* --- Event Listeners --- */

    enterBtn.addEventListener('click', () => {
        landingPage.classList.add('hidden');
        startScreen.classList.remove('hidden');
    });

    startBtn.addEventListener('click', startGame);
    restartBtn.addEventListener('click', startGame);

    // Show Leaderboard from HUD
    showLeaderboardBtn.addEventListener('click', () => {
        if(isPlaying) {
            isPlaying = false;
            hud.classList.add('hidden');
        }
        renderLeaderboard();
        leaderboardScreen.classList.remove('hidden');
    });

    // Show Leaderboard from Game Over Screen
    showLeaderboardFinalBtn.addEventListener('click', () => {
        renderLeaderboard();
        gameOverScreen.classList.add('hidden');
        leaderboardScreen.classList.remove('hidden');
    });

    // Close Leaderboard
    closeLeaderboardBtn.addEventListener('click', () => {
        leaderboardScreen.classList.add('hidden');
        
        // If returning from the in-game pause
        if (hud.classList.contains('hidden') && gameOverScreen.classList.contains('hidden')) {
             isPlaying = true;
             hud.classList.remove('hidden');
             lastTime = performance.now(); // Reset time to avoid jump
             requestAnimationFrame(gameLoop);
        } 
        // If returning from the game over screen, stay on game over screen
        else if (gameOverScreen.classList.contains('hidden') === false) {
            // Do nothing, stay on game over screen
        }
    });

    // Share Score
    shareScoreBtn.addEventListener('click', generateAndShareImage);

</script>
</body>
</html>
