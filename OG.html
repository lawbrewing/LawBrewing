<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Law Brewing Defender</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rye&family=Roboto+Slab:wght@400;700&display=swap');

        body {
            background-color: #1a1a1a;
            color: white;
            font-family: 'Roboto Slab', serif;
            overflow: hidden;
            touch-action: none; /* Prevent zooming/scrolling on mobile */
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, #2a2a2a 0%, #000000 100%);
            overflow: hidden;
        }

        /* The Logo Background */
        #bg-logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80vmin; /* Keep the container square */
            height: 80vmin;
            opacity: 0.4; /* Increased opacity for brighter colors */
            pointer-events: none;
            z-index: 0;
            /* Ensure SVG scales correctly within this container */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #bg-logo svg {
            width: 100%;
            height: 100%;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        .ui-overlay {
            position: absolute;
            z-index: 20;
            pointer-events: none; /* Let clicks pass through to canvas when playing */
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            font-size: 1.5rem;
            text-shadow: 2px 2px 0 #000;
            z-index: 20;
            pointer-events: none;
        }

        .btn {
            background: #fff;
            color: #000;
            border: 4px solid #fff;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-family: 'Rye', serif;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: transform 0.1s, background 0.2s;
            pointer-events: auto;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .btn:hover {
            transform: scale(1.05);
            background: #eee;
        }

        .btn:active {
            transform: scale(0.95);
        }

        h1 {
            font-family: 'Rye', serif;
            font-size: 4rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 4px 10px rgba(0,0,0,0.8);
            color: #fff;
        }
        
        h2 {
            font-family: 'Rye', serif;
            font-size: 2rem;
            margin-bottom: 2rem;
            color: #ccc;
        }

        .hidden {
            display: none !important;
        }
        
        .tutorial {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #555;
            max-width: 90%;
            width: 400px;
        }

        .icon-row {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .icon-box {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .icon-desc {
            font-size: 0.9rem;
            margin-top: 5px;
            color: #aaa;
        }
        
        /* Level Transition Text Style */
        #level-transition {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Rye', serif;
            font-size: 5rem;
            color: gold;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.8), 0 0 20px black;
            z-index: 30;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            /* FIX: Ensure the text content itself is centered */
            text-align: center;
        }
        .show-transition {
            opacity: 1 !important;
        }

    </style>
</head>
<body>

<div id="game-container">
    <!-- Branding Background -->
    <div id="bg-logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 600" preserveAspectRatio="xMidYMid meet">
            <defs>
                <linearGradient id="metal" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#d9d9d9"/>
                    <stop offset="100%" stop-color="#7a7a7a"/>
                </linearGradient>
                <linearGradient id="gold" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" stop-color="#ffeb8a"/>
                    <stop offset="100%" stop-color="#c59a00"/>
                </linearGradient>
            </defs>

            <!-- Outer ring -->
            <circle cx="300" cy="300" r="260" fill="url(#metal)" stroke="#000" stroke-width="6"/>

            <!-- Star -->
            <polygon
                points="300,70 355,240 535,240 390,345 445,515 300,410 155,515 210,345 65,240 245,240"
                fill="url(#metal)" stroke="#000" stroke-width="5"
            />

            <!-- LAW text (raised up slightly) - Using 'Rye' font for style consistency -->
            <text x="300" y="285"
                  font-family="Rye, serif"
                  font-size="150"
                  text-anchor="middle"
                  fill="url(#gold)"
                  stroke="#000"
                  stroke-width="4">
                LAW
            </text>

            <!-- BREWING (horizontal below LAW) - Using 'Rye' font for style consistency -->
            <text x="300" y="380"
                  font-family="Rye, serif"
                  font-size="70"
                  text-anchor="middle"
                  fill="url(#gold)"
                  stroke="#000"
                  stroke-width="3">
                BREWING
            </text>
        </svg>
    </div>

    <!-- Canvas for Gameplay -->
    <canvas id="gameCanvas"></canvas>

    <!-- Heads Up Display -->
    <div id="hud" class="hud hidden">
        <div>LEVEL: <span id="level">1</span></div>
        <div>SCORE: <span id="score">0</span></div>
        <div>LIVES: <span id="lives">3</span></div>
    </div>
    
    <!-- Level Transition Message -->
    <div id="level-transition"></div>

    <!-- Start Screen -->
    <div id="start-screen" class="ui-overlay">
        <h1>LAW<br>BREWING</h1>
        <h2>Quality Control</h2>
        
        <div class="tutorial">
            <p>You are the Sheriff of Taps.</p>
            <div class="icon-row">
                <div class="icon-box">
                    <!-- Cheap Beer Icon SVG -->
                    <svg width="50" height="80" viewBox="0 0 50 80">
                        <rect x="10" y="10" width="30" height="60" rx="2" fill="#9ca3af" stroke="#4b5563" stroke-width="2"/>
                        <rect x="10" y="20" width="30" height="40" fill="#ef4444" opacity="0.8"/>
                        <text x="25" y="45" text-anchor="middle" font-family="sans-serif" font-size="10" fill="white">SWILL</text>
                    </svg>
                    <span class="icon-desc">SHOOT THIS<br>(Bad Beer)</span>
                </div>
                <div class="icon-box">
                    <!-- Good Beer Icon SVG -->
                    <svg width="50" height="80" viewBox="0 0 50 80">
                        <path d="M10 10 L15 70 L35 70 L40 10 Z" fill="#d97706" stroke="#fff" stroke-width="2" opacity="0.8"/>
                        <path d="M10 10 Q25 0 40 10 L40 20 L10 20 Z" fill="#fff"/>
                    </svg>
                    <span class="icon-desc">SAVE THIS<br>(Law Brew)</span>
                </div>
            </div>
            <p>Don't let cheap beer reach the patrons!</p>

            <!-- HAZARD WARNING SECTION -->
            <div id="level-2-hazard" style="margin-top: 15px; border-top: 1px dashed #444; padding-top: 15px;">
                <p style="color: #ffeb3b; font-weight: bold;">[LEVEL 2 WARNING: THE OLD TIMER]</p>
                <p>The Old Timer will appear from the sides, trying to spend his last $1 on cheap swill. Avoid shooting him, but prevent him from stealing SWILL!</p>
                
                <div class="icon-box" style="margin-top: 10px;">
                    <!-- Patron Raider Icon SVG (Simple figure drawing) -->
                    <svg width="50" height="50" viewBox="0 0 50 50">
                        <!-- Hat (Brown/Gold) -->
                        <rect x="15" y="5" width="20" height="5" fill="#b45309"/>
                        <path d="M15 10 A10 5 0 0 1 35 10" fill="#b45309"/>
                        <!-- Head (Peach/Skin tone) -->
                        <circle cx="25" cy="15" r="7" fill="#fdbd9c"/>
                        <!-- Body (Gray/Elderly clothes) -->
                        <rect x="10" y="22" width="30" height="20" fill="#4b5563"/>
                        <!-- Cane/Arm (reaching) -->
                        <polyline points="30,25 40,20 40,35" fill="none" stroke="#a16207" stroke-width="3"/>
                    </svg>
                    <span class="icon-desc">AVOID SHOOTING<br>(The Old Timer)</span>
                </div>
            </div>
        </div>

        <button id="start-btn" class="btn">Start Shift</button>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="ui-overlay hidden">
        <h1>SHIFT OVER</h1>
        <h2>Final Score: <span id="final-score">0</span></h2>
        <p id="game-over-msg" style="margin-bottom: 20px; font-size: 1.2rem; color: #aaa;">Too much bad beer served!</p>
        <button id="restart-btn" class="btn">Re-Open Tab</button>
    </div>
</div>

<script>
    /* --- Game Setup --- */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // UI Elements
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const hud = document.getElementById('hud');
    const scoreEl = document.getElementById('score');
    const livesEl = document.getElementById('lives');
    const levelEl = document.getElementById('level'); 
    const finalScoreEl = document.getElementById('final-score');
    const startBtn = document.getElementById('start-btn');
    const restartBtn = document.getElementById('restart-btn');
    const levelTransitionEl = document.getElementById('level-transition'); 

    // --- Level Configuration (0-indexed for simplicity) ---
    const levelsConfig = [
        { scoreToClear: 1000, spawnIntervalMs: 1500, speedMultiplier: 1.0 }, // Level 1 (Tutorial/Easy)
        { scoreToClear: 2500, spawnIntervalMs: 1200, speedMultiplier: 1.3, thiefSpawnMs: 7000 }, // Level 2 (Old Timer active)
        { scoreToClear: 4500, spawnIntervalMs: 1000, speedMultiplier: 1.6, thiefSpawnMs: 5000 }, // Level 3
        { scoreToClear: 7000, spawnIntervalMs: 800, speedMultiplier: 2.0, thiefSpawnMs: 4000 },  // Level 4
        { scoreToClear: 10000, spawnIntervalMs: 650, speedMultiplier: 2.5, thiefSpawnMs: 3000 } // Level 5 (Final)
        // After this, it switches to Expert Mode (endless play)
    ];


    // Game State
    let isPlaying = false;
    let score = 0;
    let lives = 3;
    let currentLevel = 1;
    let lastTime = 0;
    
    // Spawning/Difficulty variables
    let spawnTimer = 0;
    let spawnInterval = levelsConfig[0].spawnIntervalMs; 
    let speedMultiplier = levelsConfig[0].speedMultiplier;
    let thiefSpawnTimer = 0;
    let thiefSpawnInterval = 8000; // Default until set by level config

    let isTransitioning = false;
    
    // Arrays for entities
    let beers = [];
    let particles = [];
    let clickEffects = [];
    let thieves = []; // Renamed from PatronRaiders conceptually, but class name remains PatronRaider for code simplicity

    /* --- Resize Handling --- */
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    /* --- Input Handling --- */
    const handleInput = (x, y) => {
        if (!isPlaying || isTransitioning) return; // Block input during transition

        // Create click effect (muzzle flash / tap ring)
        clickEffects.push({x, y, age: 0});

        // 1. Check collisions with thieves (The Old Timer)
        for (let i = thieves.length - 1; i >= 0; i--) {
            const t = thieves[i];
            const dist = Math.hypot(t.x - x, t.y - y);
            
            // Hitbox radius approx 25px
            if (dist < t.size / 2) { 
                // Hit the Old Timer! Penalty.
                t.isHit = true;
                lives--;
                livesEl.innerText = lives;
                createFloatingText(t.x, t.y, "INNOCENT SHOT", "red");
                createExplosion(t.x, t.y, '#fdbd9c'); // Flesh tone explosion
                checkGameOver();
                return; // Stop checking further collisions
            }
        }

        // 2. Check collisions with beers
        for (let i = beers.length - 1; i >= 0; i--) {
            const b = beers[i];
            const dist = Math.hypot(b.x - x, b.y - y);
            
            // Hitbox radius approx 40px
            if (dist < 50) {
                if (b.type === 'BAD') {
                    // Correct hit!
                    createExplosion(b.x, b.y, '#9ca3af'); // Metallic explosion
                    beers.splice(i, 1);
                    score += 100;
                    scoreEl.innerText = score;
                    checkLevelUp();
                } else {
                    // Oops, shot a good beer
                    createExplosion(b.x, b.y, '#d97706'); // Amber explosion
                    beers.splice(i, 1);
                    lives--;
                    livesEl.innerText = lives;
                    createFloatingText(b.x, b.y, "-1 LIFE", "red");
                    checkGameOver();
                }
                return; // Only hit one at a time per click.
            }
        }
    };

    canvas.addEventListener('mousedown', (e) => {
        handleInput(e.clientX, e.clientY);
    });

    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault(); // prevent scrolling
        for (let i = 0; i < e.touches.length; i++) {
            handleInput(e.touches[i].clientX, e.touches[i].clientY);
        }
    }, {passive: false});

    /* --- Classes --- */

    class Beer {
        constructor() {
            this.radius = 30;
            this.x = Math.random() * (canvas.width - 60) + 30;
            this.y = -50;
            // 70% chance of Bad beer (Targets), 30% chance of Good beer (Civilians)
            this.type = Math.random() > 0.3 ? 'BAD' : 'GOOD'; 
            
            // Speed uses the global speedMultiplier derived from the current level
            const baseSpeed = canvas.height / 500; 
            this.speed = (baseSpeed * speedMultiplier) * (1 + Math.random() * 0.5); 
            
            this.rotation = 0;
            this.rotSpeed = (Math.random() - 0.5) * 0.1;
        }

        update(dt) {
            this.y += this.speed;
            this.rotation += this.rotSpeed;
        }

        draw(ctx) {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);

            if (this.type === 'BAD') {
                // Draw Cheap Beer Can
                // Can Body
                ctx.fillStyle = '#9ca3af'; // Grey silver
                ctx.fillRect(-15, -25, 30, 50);
                // Rim
                ctx.fillStyle = '#d1d5db';
                ctx.fillRect(-15, -25, 30, 5);
                ctx.fillRect(-15, 20, 30, 5);
                // Label (Generic Red Stripe)
                ctx.fillStyle = '#ef4444';
                ctx.fillRect(-15, -10, 30, 20);
                // Text
                ctx.fillStyle = 'white';
                ctx.font = 'bold 10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText("SWILL", 0, 5);
            } else {
                // Draw Good Law Beer (Pint Glass)
                // Glass shape
                ctx.beginPath();
                ctx.moveTo(-15, -25);
                ctx.lineTo(-10, 25);
                ctx.lineTo(10, 25);
                ctx.lineTo(15, -25);
                ctx.closePath();
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#fff';
                ctx.stroke();

                // Liquid
                ctx.beginPath();
                ctx.moveTo(-13, -15);
                ctx.lineTo(-9, 23);
                ctx.lineTo(9, 23);
                ctx.lineTo(13, -15);
                ctx.closePath();
                ctx.fillStyle = '#d97706'; // Amber
                ctx.fill();

                // Foam
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.ellipse(0, -15, 13, 5, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Mini Logo on Glass
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(0, 0, 5, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.restore();
        }
    }

    class PatronRaider {
        constructor() {
            this.size = 50;
            this.y = Math.random() * (canvas.height * 0.4) + 100; // Start somewhere in the top half
            
            // Randomly spawn from left or right
            if (Math.random() < 0.5) {
                this.x = -this.size;
                this.vx = 0.5 + Math.random() * 0.5 * speedMultiplier; // Move right
                this.side = 'left';
            } else {
                this.x = canvas.width + this.size;
                this.vx = -(0.5 + Math.random() * 0.5 * speedMultiplier); // Move left
                this.side = 'right';
            }
            
            // Give a slight downward drift (to make them interact with falling beers)
            this.vy = 0.1 + Math.random() * 0.1 * speedMultiplier; 
            
            this.isHit = false;
            this.life = 100; // Used for fading out if removed
            this.decayRate = 3; 
        }

        update() {
            this.x += this.vx;
            this.y += this.vy;
            
            // Fade out if hit
            if (this.isHit) {
                this.life -= this.decayRate;
            }
        }

        draw(ctx) {
            // Simple Old Man Icon (Brown hat, gray body)
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.globalAlpha = this.life / 100;
            
            // Scale and rotate for movement effect
            let scaleX = 1;
            if (this.side === 'right') scaleX = -1;
            ctx.scale(scaleX, 1);

            // Hat (Brown/Gold)
            ctx.fillStyle = '#b45309';
            ctx.beginPath();
            ctx.ellipse(0, -25, 20, 10, 0, Math.PI, 0, true);
            ctx.fill();
            ctx.fillRect(-15, -25, 30, 5); // Hat brim

            // Head (Peach/Skin tone)
            ctx.fillStyle = '#fdbd9c';
            ctx.beginPath();
            ctx.arc(0, -15, 10, 0, Math.PI * 2);
            ctx.fill();

            // Body (Gray/Elderly clothes)
            ctx.fillStyle = '#4b5563'; 
            ctx.fillRect(-15, -10, 30, 30);
            
            // Cane/Arm (reaching out to grab a beer)
            ctx.lineWidth = 4;
            ctx.strokeStyle = '#a16207';
            ctx.beginPath();
            ctx.moveTo(15, -5);
            ctx.lineTo(25, -15);
            ctx.stroke();

            ctx.globalAlpha = 1.0;
            ctx.restore();
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.color = color;
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 5 + 2;
            this.vx = Math.cos(angle) * speed;
            this.vy = Math.sin(angle) * speed;
            this.life = 1.0;
            this.decay = Math.random() * 0.03 + 0.02;
            this.size = Math.random() * 4 + 2;
        }

        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.vy += 0.2; // Gravity
            this.life -= this.decay;
        }

        draw(ctx) {
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
            ctx.fill();
            ctx.globalAlpha = 1.0;
        }
    }

    class FloatingText {
        constructor(x, y, text, color) {
            this.x = x;
            this.y = y;
            this.text = text;
            this.color = color;
            this.life = 1.0;
            this.vy = -2;
        }
        update() {
            this.y += this.vy;
            this.life -= 0.02;
        }
        draw(ctx) {
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillStyle = this.color;
            ctx.font = "bold 20px 'Roboto Slab'";
            ctx.textAlign = 'center';
            ctx.fillText(this.text, this.x, this.y);
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;
            ctx.strokeText(this.text, this.x, this.y);
            ctx.globalAlpha = 1.0;
        }
    }

    /* --- Helper Functions --- */

    function createExplosion(x, y, color) {
        for(let i=0; i<15; i++) {
            particles.push(new Particle(x, y, color));
        }
    }

    function createFloatingText(x, y, text, color) {
        particles.push(new FloatingText(x, y, text, color));
    }

    function checkGameOver() {
        if (lives <= 0) {
            endGame();
        }
    }

    function checkLevelUp() {
        // Check if we are still within the pre-defined levels
        if (currentLevel <= levelsConfig.length) {
            const currentLevelIndex = currentLevel - 1;
            const requiredScore = levelsConfig[currentLevelIndex].scoreToClear;

            if (score >= requiredScore) {
                // Level cleared!
                currentLevel++;
                transitionToLevel(currentLevel);
            }
        }
        // If currentLevel > levelsConfig.length, we are in Expert Mode (endless play)
    }

    function transitionToLevel(newLevel) {
        isTransitioning = true;
        beers = []; // Clear all existing beers
        thieves = []; // Clear all existing thieves
        spawnTimer = 0; // Reset spawn timer
        thiefSpawnTimer = 0; // Reset thief timer

        let transitionText;
        if (newLevel <= levelsConfig.length) {
            transitionText = `LEVEL ${newLevel}`;
        } else {
            transitionText = `EXPERT MODE`;
        }
        
        levelTransitionEl.textContent = transitionText;
        levelTransitionEl.classList.add('show-transition');

        // Update difficulty based on the new level config
        if (newLevel <= levelsConfig.length) {
            const nextLevelConfig = levelsConfig[newLevel - 1];
            spawnInterval = nextLevelConfig.spawnIntervalMs;
            speedMultiplier = nextLevelConfig.speedMultiplier;
            // Set thief spawn interval if available (Level 2+)
            if (nextLevelConfig.thiefSpawnMs) {
                thiefSpawnInterval = nextLevelConfig.thiefSpawnMs;
            }
            levelEl.textContent = newLevel;
        } else {
            // Expert Mode settings
            spawnInterval = 600; // Very fast beer spawn
            speedMultiplier = 3.0; // Very fast speed
            thiefSpawnInterval = 3000; // Fast thief spawn
            levelEl.textContent = 'E';
        }

        // Hide transition message and resume play after a delay
        setTimeout(() => {
            levelTransitionEl.classList.remove('show-transition');
            isTransitioning = false;
        }, 1500); // 1.5 second pause
    }

    function endGame() {
        isPlaying = false;
        hud.classList.add('hidden');
        gameOverScreen.classList.remove('hidden');
        finalScoreEl.innerText = score;
    }

    function startGame() {
        // Reset state
        score = 0;
        lives = 3;
        currentLevel = 1;

        // Initialize to Level 1 settings
        spawnInterval = levelsConfig[0].spawnIntervalMs;
        speedMultiplier = levelsConfig[0].speedMultiplier;
        thiefSpawnInterval = 8000; // Set a default high value for L1 (won't trigger anyway)

        scoreEl.innerText = score;
        livesEl.innerText = lives;
        levelEl.innerText = currentLevel;
        beers = [];
        particles = [];
        clickEffects = [];
        thieves = []; // Reset thieves
        spawnTimer = 0;
        thiefSpawnTimer = 0;
        isTransitioning = false;
        
        isPlaying = true;
        startScreen.classList.add('hidden');
        gameOverScreen.classList.add('hidden');
        hud.classList.remove('hidden');
        
        lastTime = performance.now();
        requestAnimationFrame(gameLoop);
    }

    /* --- Game Loop --- */

    function gameLoop(timestamp) {
        if (!isPlaying) return;

        const dt = timestamp - lastTime;
        lastTime = timestamp;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // --- Spawning Logic ---
        if (!isTransitioning) {
            // Beer Spawning
            spawnTimer += dt;
            if (spawnTimer > spawnInterval) {
                beers.push(new Beer());
                spawnTimer = 0;
            }

            // Thief Spawning (Only starts after Level 1)
            if (currentLevel > 1) {
                thiefSpawnTimer += dt;
                if (thiefSpawnTimer > thiefSpawnInterval) {
                    thieves.push(new PatronRaider());
                    thiefSpawnTimer = 0;
                }
            }
        }

        // --- Update & Draw Thieves (The Old Timer) ---
        for (let i = thieves.length - 1; i >= 0; i--) {
            const t = thieves[i];
            t.update();
            t.draw(ctx);
            
            // Check Beer-Thief collision (only if thief is active/not hit)
            if (!t.isHit) {
                for (let j = beers.length - 1; j >= 0; j--) {
                    const b = beers[j];
                    const dist = Math.hypot(b.x - t.x, b.y - t.y);

                    // Collision check (Thief size/2 is 25, Beer radius is 30)
                    if (dist < b.radius + t.size / 4) { 
                        if (b.type === 'BAD') {
                            // Thief successfully grabbed a bad beer! Penalty.
                            lives--;
                            livesEl.innerText = lives;
                            createFloatingText(t.x, t.y, "STOLEN SWILL!", "red");
                            
                            // Remove both beer and thief
                            createExplosion(t.x, t.y, 'red'); 
                            beers.splice(j, 1);
                            t.isHit = true; // Mark thief for removal (fades out)
                        } else {
                            // Thief grabbed a good beer (Law Brew), just remove both
                            createFloatingText(b.x, b.y, "SAFE LAW BREW!", "#4ade80");
                            beers.splice(j, 1);
                            t.isHit = true;
                        }
                        checkGameOver();
                        break; // Stop checking beers for this thief
                    }
                }
            }

            // Removal Logic for Thief
            // 1. If hit and faded out
            if (t.isHit && t.life <= 0) {
                thieves.splice(i, 1);
                continue;
            }

            // 2. If thief moves off screen horizontally (and was not hit)
            const isOffScreen = t.side === 'left' ? t.x > canvas.width + t.size : t.x < -t.size;
            if (isOffScreen && !t.isHit) {
                thieves.splice(i, 1);
            }
        }


        // --- Update & Draw Beers ---
        for (let i = beers.length - 1; i >= 0; i--) {
            const b = beers[i];
            b.update(dt);
            b.draw(ctx);

            // Remove if off screen (missed by player/thief)
            if (b.y > canvas.height + 50) {
                beers.splice(i, 1);
                
                // Logic for missing:
                if (b.type === 'BAD') {
                    // Missed a bad beer! It reached the patron line!
                    lives--;
                    livesEl.innerText = lives;
                    createFloatingText(canvas.width/2, canvas.height - 100, "BAD BEER SERVED!", "red");
                } else {
                    // Good beer reached safety!
                    score += 50;
                    scoreEl.innerText = score;
                    createFloatingText(b.x, canvas.height - 50, "+50", "#4ade80");
                }
                checkGameOver();
            }
        }

        // Update & Draw Particles (and Text)
        for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.update();
            p.draw(ctx);
            if (p.life <= 0) {
                particles.splice(i, 1);
            }
        }

        // Click Effects
        for (let i = clickEffects.length - 1; i >= 0; i--) {
            const c = clickEffects[i];
            c.age++;
            ctx.beginPath();
            ctx.arc(c.x, c.y, 10 + c.age * 2, 0, Math.PI * 2);
            ctx.strokeStyle = `rgba(255, 255, 255, ${1 - c.age / 10})`;
            ctx.lineWidth = 2;
            ctx.stroke();
            if (c.age > 10) clickEffects.splice(i, 1);
        }

        // Danger Line at bottom
        ctx.fillStyle = 'rgba(255, 0, 0, 0.1)';
        ctx.fillRect(0, canvas.height - 20, canvas.width, 20);
        ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText("PATRONS (BAR)", canvas.width/2, canvas.height - 5);

        requestAnimationFrame(gameLoop);
    }

    /* --- Events --- */
    startBtn.addEventListener('click', startGame);
    restartBtn.addEventListener('click', startGame);

</script>
</body>
</html>
